<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FofocaDoGrupo ‚Äî Fofoca Management</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0f14; color: #e6edf3; }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2a37; display:flex; gap:12px; align-items:center; }
    .brand { font-weight: 800; letter-spacing: 0.5px; }
    .tagline { opacity: .75; font-size: 12px; }

    .wrap { max-width: 1600px; margin: 0 auto; }

    main.wrap {
      display: grid;
      grid-template-columns: minmax(460px, 560px) minmax(560px, 760px) minmax(420px, 560px);
      gap: 16px;
      padding: 16px;
      align-items:start;
    }

    .card { background: #0f1620; border: 1px solid #1f2a37; border-radius: 14px; padding: 14px; }
    .cardTitle { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    input, textarea, select, button {
      width: 100%; box-sizing: border-box; padding: 10px 10px; border-radius: 10px;
      border: 1px solid #243244; background: #0b111a; color: #e6edf3; outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    button { cursor: pointer; background: #1b3a57; border-color: #2b4a66; font-weight: 700; }
    button:hover { filter: brightness(1.08); }
    button:disabled { opacity: .45; cursor:not-allowed; filter:none; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { opacity: .75; font-size: 12px; }

    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding: 2px 8px; border-radius: 999px;
      border: 1px solid #2a3a52; font-size: 11px; line-height: 1.4;
      opacity:.92; white-space: nowrap;
    }
    .pill.small { padding: 2px 7px; font-size: 11px; opacity: .9; }
    .pill.ghost { background: transparent; }
    .danger { background:#4a1d1d; border-color:#6a2b2b; }
    .good { background:#153a2a; border-color:#1f5b40; }
    .ghost { background: transparent; border-color: #2a3a52; }

    .kpis { display:flex; gap:10px; flex-wrap:wrap; }
    .kpi { background:#0b111a; border:1px solid #203044; border-radius: 14px; padding: 10px 12px; min-width: 140px; }
    .kpi .v { font-size: 18px; font-weight: 800; }
    .kpi .l { font-size: 12px; opacity:.75; }

    .list { display:flex; flex-direction: column; gap: 10px; }

    .feedGrid { display: grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 1200px){ .feedGrid { grid-template-columns: 1fr 1fr; } }

    .feedItem{
      border: 1px solid #203044; background:#0b111a;
      border-radius: 14px; padding: 12px;
      display:flex; flex-direction: column; gap: 10px;
    }
    .feedItem.active{ border-color:#3a5677; }
    .feedItem:hover{ border-color:#2d425c; }
    .feedTop{ display:flex; align-items:flex-start; justify-content: space-between; gap: 12px; }
    .feedTitle{ margin: 0; font-size: 16px; line-height: 1.25; font-weight: 800; }
    .openBtn{
      width:auto; padding: 8px 10px; border-radius: 10px;
      background:#153a2a; border-color:#1f5b40; white-space: nowrap;
    }
    .metaRow{ display:flex; gap: 8px; flex-wrap:wrap; }
    .preview{
      opacity:.9; font-size: 13px; line-height: 1.35;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .reactLine{ display:flex; gap: 8px; flex-wrap:wrap; }
    .reactLine .pill{ opacity:.9; }

    .detailsBox { white-space:pre-wrap; line-height:1.4; }
    .commentBox { display:flex; gap:10px; align-items:flex-start; }
    .commentBox textarea { min-height: 60px; }
    .comment { border:1px solid #203044; border-radius: 14px; background:#0b111a; padding: 10px; }
    .comment .who { font-weight:700; }
    .comment .when { opacity:.7; font-size:12px; margin-left:6px; }
    .comment .body { white-space:pre-wrap; margin-top:6px; }

    .reactRow { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .reactBtn { width:auto; padding: 8px 10px; background: transparent; border-color:#2a3a52; }
    .reactBtn:hover { filter:none; border-color:#3a5677; }

    .topRight { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; margin-left:auto; }
    .bell { width:auto; padding: 10px 12px; background: transparent; border-color:#2a3a52; position:relative; }
    .badge { position:absolute; top:-6px; right:-6px; background:#153a2a; border:1px solid #1f5b40; padding:2px 6px; border-radius:999px; font-size:12px; }

    .notifPanel { display:none; margin-top:10px; }
    .notifItem { border:1px solid #203044; background:#0b111a; border-radius:14px; padding:10px; }
    .notifItem.unread { border-color:#3a5677; }
    .inline { display:flex; gap:10px; }
    .inline button { width:auto; }

    .tabs { display:flex; gap:10px; flex-wrap:wrap; }
    .tabbtn { width:auto; padding: 10px 12px; }
    .tabbtn.active { background:#153a2a; border-color:#1f5b40; }

    /* Modals simples */
    .modalBackdrop{
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      z-index: 50;
      padding: 16px;
    }
    .modal{
      max-width: 720px;
      margin: 40px auto;
      background: #0f1620;
      border: 1px solid #1f2a37;
      border-radius: 14px;
      padding: 14px;
    }
    .modalHeader{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .modalHeader h3{ margin:0; }
    .modalClose{ width:auto; background: transparent; border-color:#2a3a52; }
    .linkBtn{
      width:auto;
      background: transparent;
      border-color:#2a3a52;
      padding: 6px 10px;
      font-weight: 700;
    }
    .authorLink{
      cursor:pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    @media (max-width: 1300px){
      main.wrap { grid-template-columns: minmax(460px, 560px) 1fr; }
      #viewerCard { grid-column: 1 / -1; }
    }
    @media (max-width: 980px){
      main.wrap { grid-template-columns: 1fr; }
      .kpi { min-width: 120px; }
      #viewerCard { grid-column: auto; }
      .feedGrid { grid-template-columns: 1fr; }
    }

    /* Viewer sticky no desktop */
    @media (min-width: 1301px){
      #viewerCard{
        position: sticky;
        top: 16px;
        align-self: start;
        max-height: calc(100vh - 32px);
        overflow: auto;
      }
    }
  </style>
</head>

<body>
<header class="wrap">
  <div>
    <div class="brand">Fofoca Do Grupo</div>
    <div class="tagline">Fofoca Management ‚Ä¢ Observability ‚Ä¢ Compliance ‚Ä¢ Governan√ßa de Tias</div>
  </div>

  <div class="topRight">
    <button id="bellBtn" class="bell" style="display:none;">üîî
      <span id="bellBadge" class="badge" style="display:none;">0</span>
    </button>
    <span id="who" class="muted"></span>
    <button id="logoutBtn" style="width:auto; display:none;">Sair</button>
  </div>
</header>

<main class="wrap">
  <!-- AUTH -->
  <section class="card" id="authCard">
    <h2 id="authTitle" style="margin-top:0;">Acesso</h2>
    <div id="authHint" class="muted">
      Entre com sua conta. Se ainda n√£o tiver, clique em <b>Criar conta</b>.
    </div>

    <div style="margin-top:10px; display:none;" id="nameField">
      <input id="n" placeholder="Nome (ex: Dona Cida do 302)"/>
    </div>

    <div style="margin-top:10px;">
      <input id="u" placeholder="Usu√°rio (ex: lucas_fofoca)" />
    </div>

    <div style="margin-top:10px;">
      <input id="p" placeholder="Senha" type="password" />
    </div>

    <div class="row" id="authButtons" style="margin-top:10px;">
      <button id="loginBtn">Entrar</button>
      <button id="goRegisterBtn" class="good">Criar conta</button>
    </div>

    <div id="registerButtons" style="display:none; margin-top:10px;">
      <button id="registerBtn" class="good">Confirmar cadastro</button>
      <div style="height:10px;"></div>
      <button id="backToLoginBtn" class="ghost">Voltar para o login</button>
    </div>

    <div id="authMsg" class="muted" style="margin-top:10px;"></div>
  </section>

  <!-- SIDEBAR -->
  <section class="card" id="sidebarCard" style="display:none;">
    <div class="cardTitle">
      <h2 style="margin:0;">Dashboard</h2>
      <button id="refreshBtn" style="width:auto;">Atualizar</button>
    </div>

    <div style="height:10px;"></div>
    <div class="kpis" id="kpis"></div>

    <div style="height:10px;"></div>
    <div id="profile" class="muted"></div>

    <div style="height:14px;"></div>
    <h3 style="margin:0 0 10px 0;">Filtros</h3>

    <div class="row">
      <input id="q" placeholder="Pesquisar..." />
      <select id="statusFilter">
        <option value="">Todas</option>
        <option value="APURACAO">APURA√á√ÉO</option>
        <option value="CONFIRMADO">CONFIRMADO</option>
        <option value="ARQUIVADO">ARQUIVADO</option>
      </select>
    </div>

    <div style="height:10px;"></div>
    <div class="row">
      <select id="sort">
        <option value="hot">Feed: Quentes</option>
        <option value="new">Feed: Recentes</option>
        <option value="commented">Feed: Mais comentadas</option>
      </select>
      <button id="applyBtn" class="ghost">Aplicar</button>
    </div>

    <div style="height:18px;"></div>
    <h3 style="margin:0 0 10px 0;">Nova ocorr√™ncia</h3>

    <div class="row">
      <div>
        <label class="muted">T√≠tulo</label>
        <input id="title" placeholder="Ex: Fulano foi visto..." />
      </div>
      <div>
        <label class="muted">Fonte</label>
        <input id="source" placeholder="Ex: zelador, grupo da fam√≠lia" />
      </div>
    </div>

    <div style="height:10px;"></div>
    <label class="muted">Detalhes</label>
    <textarea id="details" placeholder="Dica: use @usuario para mencionar algu√©m üòÑ"></textarea>

    <div style="height:10px;"></div>
    <div class="row">
      <div>
        <label class="muted">Status</label>
        <select id="status">
          <option value="APURACAO">APURA√á√ÉO</option>
          <option value="CONFIRMADO">CONFIRMADO</option>
          <option value="ARQUIVADO">ARQUIVADO</option>
        </select>
      </div>
      <div>
        <label class="muted">Confiabilidade (0‚Äì100)</label>
        <input id="cred" type="number" min="0" max="100" value="50"/>
      </div>
    </div>

    <div style="height:10px;"></div>
    <label class="muted">Tags (separadas por v√≠rgula)</label>
    <input id="tags" placeholder="ouvi falar, fonte confi√°vel, primo do amigo" />

    <div style="height:12px;"></div>
    <button id="createBtn">Registrar ticket</button>
    <div id="msg" class="muted" style="margin-top:10px;"></div>

    <div class="notifPanel" id="notifPanel">
      <div style="height:10px;"></div>
      <h3 style="margin:0 0 10px 0;">Notifica√ß√µes</h3>
      <div class="list" id="notifs"></div>
    </div>
  </section>

  <!-- EXPLORE (CENTRO) -->
  <section class="card" id="exploreCard" style="display:none;">
    <div class="cardTitle">
      <h2 style="margin:0;">Explorar</h2>
      <div class="tabs">
        <button id="tabFeed" class="tabbtn active">Feed (grupo)</button>
        <button id="tabBacklog" class="tabbtn">Meu Backlog</button>
      </div>
    </div>

    <div style="height:10px;"></div>
    <div id="list" class="feedGrid"></div>
  </section>

  <!-- VIEWER (DIREITA) -->
  <section class="card" id="viewerCard" style="display:none;">
    <div class="cardTitle">
      <h2 style="margin:0;">Visualiza√ß√£o</h2>
      <span class="muted">Detalhes + colabora√ß√£o</span>
    </div>

    <div id="viewerEmpty" class="muted" style="margin-top:10px;">
      Selecione uma fofoca no feed/backlog para ver detalhes e colaborar.
    </div>

    <div id="viewer" style="display:none; margin-top:10px;">
      <div class="metaRow" id="vMeta"></div>
      <h3 id="vTitle" style="margin: 0 0 8px 0;"></h3>
      <div id="vDetails" class="detailsBox"></div>

      <div class="reactRow" id="reactRow"></div>

      <div style="height:12px;"></div>
      <div class="metaRow" id="vTags"></div>

      <div style="height:12px;"></div>
      <div class="row">
        <button id="moveBtn">Mover status</button>
        <button id="deleteBtn" class="danger">Excluir</button>
      </div>
      <div id="permHint" class="muted" style="margin-top:8px;"></div>

      <div style="height:18px;"></div>
      <div class="cardTitle">
        <h3 style="margin:0;">Coment√°rios</h3>
        <span id="cCount" class="muted"></span>
      </div>

      <div style="height:10px;"></div>
      <div class="commentBox">
        <textarea id="cBody" placeholder="Comente‚Ä¶ (use @usuario para mencionar)"></textarea>
        <button id="cSend" style="width:auto;">Enviar</button>
      </div>
      <div id="cMsg" class="muted" style="margin-top:8px;"></div>

      <div style="height:10px;"></div>
      <div class="list" id="comments"></div>

      <div style="height:16px;"></div>
      <h3 style="margin:0 0 10px 0;">Leaderboard</h3>
      <div class="list" id="leaderboard"></div>
    </div>
  </section>
</main>

<!-- Modal: Perfil -->
<div class="modalBackdrop" id="profileModal">
  <div class="modal">
    <div class="modalHeader">
      <h3 id="pmTitle">Perfil</h3>
      <button class="modalClose" onclick="closeProfile()">Fechar</button>
    </div>
    <div style="height:10px;"></div>
    <div id="pmBody" class="muted"></div>
    <div style="height:12px;"></div>
    <div class="list" id="pmGossips"></div>
  </div>
</div>

<!-- Modal: Mover status -->
<div class="modalBackdrop" id="statusModal">
  <div class="modal">
    <div class="modalHeader">
      <h3>Mover status</h3>
      <button class="modalClose" onclick="closeStatusModal()">Fechar</button>
    </div>
    <div style="height:10px;"></div>
    <div class="muted">Escolha para qual status deseja mover:</div>
    <div style="height:10px;"></div>
    <select id="statusSelect">
      <option value="APURACAO">APURA√á√ÉO</option>
      <option value="CONFIRMADO">CONFIRMADO</option>
      <option value="ARQUIVADO">ARQUIVADO</option>
    </select>
    <div style="height:12px;"></div>
    <div class="row">
      <button class="good" onclick="confirmMoveStatus()">Confirmar</button>
      <button class="ghost" onclick="closeStatusModal()">Cancelar</button>
    </div>
  </div>
</div>

<script>
let TOKEN = null;
let MY = null; // /api/me
let MODE = "login";
let SELECTED_ID = null;
let SELECTED_GOSSIP = null;
let ACTIVE_TAB = "feed"; // feed | backlog

const REACTS = [
  {k:"LIKE", e:"üëç", t:"Confirmo"},
  {k:"LOL",  e:"üòÇ", t:"KKK"},
  {k:"WOW",  e:"üòÆ", t:"Chocado"},
  {k:"SUS",  e:"ü§î", t:"Suspeito"},
  {k:"FIRE", e:"üî•", t:"Quente"},
];

function authHeader(){ return TOKEN ? { "Authorization": "Bearer " + TOKEN } : {}; }

async function api(path, opts={}){
  const res = await fetch(path, { ...opts, headers: { "Content-Type":"application/json", ...(opts.headers||{}), ...authHeader() }});
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text; }
  if(!res.ok){
    let msg = "Erro " + res.status;
    if (data && data.detail) {
      if (Array.isArray(data.detail)) msg = data.detail.map(e => `${(e.loc||[]).slice(-1)[0]||"campo"}: ${e.msg}`).join(" | ");
      else msg = data.detail;
    }
    throw new Error(msg);
  }
  return data;
}

function fmtTs(ts){ return new Date(ts * 1000).toLocaleString(); }
function escapeHtml(str){ return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
function toPreview(text){ return (text || "").replaceAll("\r","").trim(); }

function setAuthUI(logged){
  document.getElementById("authCard").style.display = logged ? "none" : "block";
  document.getElementById("sidebarCard").style.display = logged ? "block" : "none";
  document.getElementById("exploreCard").style.display = logged ? "block" : "none";
  document.getElementById("viewerCard").style.display = logged ? "block" : "none";
  document.getElementById("logoutBtn").style.display = logged ? "inline-block" : "none";
  document.getElementById("bellBtn").style.display = logged ? "inline-block" : "none";
}

function setMode(mode){
  MODE = mode;
  const isReg = MODE === "register";
  document.getElementById("authTitle").textContent = isReg ? "Criar conta" : "Acesso";
  document.getElementById("authHint").innerHTML = isReg
    ? "Preencha os dados para cadastrar. Depois voc√™ faz login normalmente."
    : "Entre com sua conta. Se ainda n√£o tiver, clique em <b>Criar conta</b>.";
  document.getElementById("nameField").style.display = isReg ? "block" : "none";
  document.getElementById("registerButtons").style.display = isReg ? "block" : "none";
  document.getElementById("authButtons").style.display = isReg ? "none" : "grid";
  document.getElementById("authMsg").textContent = "";
}

function renderKpis(d){
  const k = document.getElementById("kpis");
  k.innerHTML = "";
  const mk = (v, l) => `<div class="kpi"><div class="v">${v}</div><div class="l">${l}</div></div>`;
  k.insertAdjacentHTML("beforeend", mk(d.total, "Tickets totais"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.APURACAO, "APURA√á√ÉO"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.CONFIRMADO, "CONFIRMADO"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.ARQUIVADO, "ARQUIVADO"));
  k.insertAdjacentHTML("beforeend", mk(d.avg_credibility.toFixed(1), "Credibilidade m√©dia"));
}

function score(g){
  const r = g.reactions || {};
  return (r.LIKE||0)*1 + (r.LOL||0)*2 + (r.WOW||0)*2 + (r.SUS||0)*1 + (r.FIRE||0)*3 + (g.comment_count||0)*2;
}

function reactLine(g){
  const r = g.reactions || {};
  return `
    <div class="reactLine">
      <span class="pill small">üëç ${r.LIKE||0}</span>
      <span class="pill small">üòÇ ${r.LOL||0}</span>
      <span class="pill small">üòÆ ${r.WOW||0}</span>
      <span class="pill small">ü§î ${r.SUS||0}</span>
      <span class="pill small">üî• ${r.FIRE||0}</span>
    </div>
  `;
}

function usernameFromLabel(label){
  // label pode ser "Nome (@username)" ou "username"
  const m = String(label).match(/@([a-zA-Z0-9_]{3,20})\)?$/);
  if(m) return m[1].toLowerCase();
  return String(label).trim().toLowerCase();
}

function itemCard(g){
  const active = (SELECTED_ID === g.id);
  const tags = (g.tags||[]).slice(0,3).map(t=>`<span class="pill small">${escapeHtml(t)}</span>`).join(" ");
  const preview = escapeHtml(toPreview(g.details)).slice(0, 500);

  const uname = usernameFromLabel(g.created_by);
  const authorHtml = `<span class="authorLink" onclick="openProfile('${uname}')">${escapeHtml(g.created_by)}</span>`;

  return `
  <div class="feedItem ${active ? "active" : ""}">
    <div class="feedTop">
      <div>
        <div class="metaRow" style="margin-bottom:8px;">
          <span class="pill small">${g.status}</span>
          <span class="pill small">Cred ${g.credibility}</span>
          <span class="pill small">Por: ${authorHtml}</span>
          ${g.created_by_title ? `<span class="pill small">üè∑Ô∏è ${escapeHtml(g.created_by_title)}</span>` : ""}
          <span class="pill small">üí¨ ${g.comment_count}</span>
          <span class="pill small">‚≠ê ${score(g)}</span>
        </div>
        <h3 class="feedTitle">${escapeHtml(g.title)}</h3>
      </div>

      <button class="openBtn" onclick="openGossip(${g.id})">Abrir</button>
    </div>

    <div class="preview">${preview || "Sem detalhes‚Ä¶"}</div>

    ${reactLine(g)}

    <div class="metaRow">
      <span class="pill small">${escapeHtml(g.source)}</span>
      <span class="pill small">${fmtTs(g.updated_at)}</span>
      ${tags || `<span class="pill small ghost">Sem tags</span>`}
    </div>
  </div>`;
}

function setTab(tab){
  ACTIVE_TAB = tab;
  document.getElementById("tabFeed").classList.toggle("active", tab==="feed");
  document.getElementById("tabBacklog").classList.toggle("active", tab==="backlog");
  clearViewer();
  refreshList();
}

async function refreshList(){
  const q = document.getElementById("q").value.trim();
  const st = document.getElementById("statusFilter").value;
  const sort = document.getElementById("sort").value;

  let data = [];
  if (ACTIVE_TAB === "feed") {
    const url = new URL(location.origin + "/api/feed");
    if(q) url.searchParams.set("q", q);
    if(st) url.searchParams.set("status_filter", st);
    url.searchParams.set("sort", sort);
    data = await api(url.pathname + url.search);
    if (sort === "hot") data.sort((a,b)=>score(b)-score(a));
  } else {
    const url = new URL(location.origin + "/api/backlog");
    if(q) url.searchParams.set("q", q);
    if(st) url.searchParams.set("status_filter", st);
    data = await api(url.pathname + url.search);
  }

  document.getElementById("list").innerHTML =
    data.map(itemCard).join("") || `<div class="muted">Nada por aqui ainda‚Ä¶</div>`;
}

async function refreshHeaderAndStats(){
  const dash = await api("/api/dashboard");
  renderKpis(dash);

  MY = await api("/api/me");
  document.getElementById("who").textContent = `Logado como: ${MY.label} ‚Ä¢ T√≠tulo: ${MY.title} ‚Ä¢ Fofocas: ${MY.total_gossips}`;

  const medals = (MY.badges||[]).map(b => `<span class="pill small">${escapeHtml(b)}</span>`).join(" ");
  document.getElementById("profile").innerHTML = medals
    ? `Conquistas: ${medals}`
    : `<span class="muted">Conquistas: nenhuma ainda‚Ä¶ poste mais babados üòÑ</span>`;
}

function clearViewer(){
  SELECTED_ID = null;
  SELECTED_GOSSIP = null;
  document.getElementById("viewerEmpty").style.display = "block";
  document.getElementById("viewer").style.display = "none";
}

async function openGossip(id){
  SELECTED_ID = id;
  SELECTED_GOSSIP = await api("/api/gossips/" + id);

  document.getElementById("viewerEmpty").style.display = "none";
  document.getElementById("viewer").style.display = "block";

  document.getElementById("vTitle").textContent = SELECTED_GOSSIP.title;
  document.getElementById("vDetails").textContent = SELECTED_GOSSIP.details;

  const uname = usernameFromLabel(SELECTED_GOSSIP.created_by);
  const authorHtml = `<span class="authorLink" onclick="openProfile('${uname}')">${escapeHtml(SELECTED_GOSSIP.created_by)}</span>`;

  document.getElementById("vMeta").innerHTML = `
    <span class="pill small">Status: ${SELECTED_GOSSIP.status}</span>
    <span class="pill small">Cred: ${SELECTED_GOSSIP.credibility}</span>
    <span class="pill small">Fonte: ${escapeHtml(SELECTED_GOSSIP.source)}</span>
    <span class="pill small">Por: ${authorHtml}</span>
    ${SELECTED_GOSSIP.created_by_title ? `<span class="pill small">üè∑Ô∏è ${escapeHtml(SELECTED_GOSSIP.created_by_title)}</span>` : ""}
    <span class="pill small">Criado: ${fmtTs(SELECTED_GOSSIP.created_at)}</span>
    <span class="pill small">Atualizado: ${fmtTs(SELECTED_GOSSIP.updated_at)}</span>
  `;

  const tags = (SELECTED_GOSSIP.tags||[]).map(t=>`<span class="pill small">${escapeHtml(t)}</span>`).join(" ");
  document.getElementById("vTags").innerHTML = tags || `<span class="pill small ghost">Sem tags</span>`;

  renderReactions();

  document.getElementById("permHint").textContent =
    "Obs: s√≥ o autor consegue mover/excluir (o servidor bloqueia).";

  document.getElementById("cBody").value = "";
  document.getElementById("cMsg").textContent = "";

  await loadComments();
  await loadLeaderboard();
  await refreshList();
}

function renderReactions(){
  const r = SELECTED_GOSSIP.reactions || {};
  document.getElementById("reactRow").innerHTML = REACTS.map(x => `
    <button class="reactBtn" onclick="toggleReaction('${x.k}')">${x.e} ${x.t} ‚Ä¢ ${(r[x.k]||0)}</button>
  `).join("");
}

async function toggleReaction(key){
  if(!SELECTED_ID) return;
  const out = await api(`/api/gossips/${SELECTED_ID}/reactions/toggle`, {
    method:"POST",
    body: JSON.stringify({reaction: key})
  });
  SELECTED_GOSSIP.reactions = out.reactions;
  renderReactions();
  await refreshList();
}

async function loadComments(){
  if(!SELECTED_ID) return;
  const comments = await api(`/api/gossips/${SELECTED_ID}/comments`);
  document.getElementById("cCount").textContent = `${comments.length} coment√°rio(s)`;

  document.getElementById("comments").innerHTML = comments.map(c => {
    const body = highlightMentions(escapeHtml(c.body));
    return `
      <div class="comment">
        <div><span class="who">${escapeHtml(c.author)}</span><span class="when">${fmtTs(c.created_at)}</span></div>
        <div class="body">${body}</div>
      </div>`;
  }).join("") || `<div class="muted">Nenhum coment√°rio ainda‚Ä¶ seja o primeiro üòÑ</div>`;
}

function highlightMentions(html){
  return html.replaceAll(/@([a-zA-Z0-9_]{3,20})/g, `<span class="pill small">@$1</span>`);
}

async function loadLeaderboard(){
  const lb = await api("/api/leaderboard?limit=10");
  document.getElementById("leaderboard").innerHTML = lb.map((x, i) => `
    <div class="feedItem">
      <div class="metaRow">
        <span class="pill small">#${i+1}</span>
        <span class="pill small">${escapeHtml(x.label)}</span>
        <span class="pill small">${x.total} fofocas</span>
      </div>
    </div>
  `).join("");
}

async function sendComment(){
  if(!SELECTED_ID) return;
  const body = document.getElementById("cBody").value.trim();
  if(body.length < 1){
    document.getElementById("cMsg").textContent = "Escreva algo antes de enviar.";
    return;
  }
  await api(`/api/gossips/${SELECTED_ID}/comments`, { method:"POST", body: JSON.stringify({body}) });
  document.getElementById("cBody").value = "";
  document.getElementById("cMsg").textContent = "Coment√°rio enviado ‚úÖ";
  await openGossip(SELECTED_ID);
  await refreshNotifications();
}

async function create(){
  const payload = {
    title: document.getElementById("title").value.trim(),
    source: document.getElementById("source").value.trim() || "an√¥nimo corporativo",
    details: document.getElementById("details").value.trim(),
    credibility: Number(document.getElementById("cred").value || 0),
    status: document.getElementById("status").value,
    tags: (document.getElementById("tags").value || "")
      .split(",").map(s => s.trim()).filter(Boolean),
  };

  if(payload.title.length < 3 || payload.details.length < 3){
    document.getElementById("msg").textContent = "Preenche t√≠tulo e detalhes, Compliance agradece.";
    return;
  }

  const created = await api("/api/gossips", { method:"POST", body: JSON.stringify(payload) });
  document.getElementById("msg").textContent = "Ticket registrado com excel√™ncia operacional.";

  document.getElementById("title").value = "";
  document.getElementById("details").value = "";
  document.getElementById("tags").value = "";

  await refreshHeaderAndStats();
  await refreshList();
  await openGossip(created.id);
}

async function delSelected(){
  if(!SELECTED_ID) return;
  if(!confirm("Excluir essa fofoca?")) return;
  try{
    await api("/api/gossips/" + SELECTED_ID, { method:"DELETE" });
  }catch(e){
    alert(e.message);
  }
  clearViewer();
  await refreshHeaderAndStats();
  await refreshList();
}

/* ======= Mover status com select ======= */
function openStatusModal(){
  if(!SELECTED_GOSSIP) return;
  document.getElementById("statusSelect").value = SELECTED_GOSSIP.status || "APURACAO";
  document.getElementById("statusModal").style.display = "block";
}
function closeStatusModal(){
  document.getElementById("statusModal").style.display = "none";
}
async function confirmMoveStatus(){
  if(!SELECTED_GOSSIP) return;
  const next = document.getElementById("statusSelect").value;
  const payload = { ...SELECTED_GOSSIP, status: next, tags: (SELECTED_GOSSIP.tags||[]) };
  try{
    const updated = await api("/api/gossips/" + SELECTED_ID, { method:"PATCH", body: JSON.stringify(payload) });
    SELECTED_GOSSIP = updated;
    closeStatusModal();
    await openGossip(SELECTED_ID);
  }catch(e){
    alert(e.message);
  }
}

/* ======= Perfil modal ======= */
function closeProfile(){
  document.getElementById("profileModal").style.display = "none";
}
async function openProfile(username){
  try{
    const prof = await api("/api/users/" + encodeURIComponent(username));
    document.getElementById("pmTitle").textContent = `Perfil ‚Äî ${prof.label}`;
    const badges = (prof.badges||[]).map(b=>`<span class="pill small">${escapeHtml(b)}</span>`).join(" ");
    document.getElementById("pmBody").innerHTML = `
      <div class="metaRow">
        <span class="pill small">üè∑Ô∏è ${escapeHtml(prof.title)}</span>
        <span class="pill small">üìå Fofocas: ${prof.total_gossips}</span>
      </div>
      <div style="height:10px;"></div>
      ${badges ? `<div class="metaRow">${badges}</div>` : `<div class="muted">Sem conquistas ainda‚Ä¶</div>`}
      <div style="height:12px;"></div>
      <div class="muted">Fofocas deste usu√°rio:</div>
    `;

    const gs = await api("/api/users/" + encodeURIComponent(username) + "/gossips?limit=50");
    document.getElementById("pmGossips").innerHTML = gs.map(g => `
      <div class="feedItem">
        <div class="metaRow">
          <span class="pill small">${g.status}</span>
          <span class="pill small">‚≠ê ${score(g)}</span>
          <span class="pill small">üí¨ ${g.comment_count}</span>
          <span class="pill small">${fmtTs(g.created_at)}</span>
        </div>
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;">
          <div style="font-weight:800;">${escapeHtml(g.title)}</div>
          <button class="openBtn" onclick="openGossip(${g.id}); closeProfile();">Abrir</button>
        </div>
        <div class="preview">${escapeHtml(toPreview(g.details))}</div>
      </div>
    `).join("") || `<div class="muted">Nenhuma fofoca ainda.</div>`;

    document.getElementById("profileModal").style.display = "block";
  }catch(e){
    alert(e.message);
  }
}

/* ===== Notifica√ß√µes ===== */
async function refreshNotifications(){
  const c = await api("/api/notifications/unread_count");
  const badge = document.getElementById("bellBadge");
  if(c.count > 0){
    badge.style.display = "inline-block";
    badge.textContent = String(c.count);
  }else{
    badge.style.display = "none";
  }
}

async function toggleNotifPanel(){
  const panel = document.getElementById("notifPanel");
  const isOpen = panel.style.display === "block";
  panel.style.display = isOpen ? "none" : "block";
  if(!isOpen){
    const notifs = await api("/api/notifications?limit=25");
    document.getElementById("notifs").innerHTML = notifs.map(n => `
      <div class="notifItem ${n.read_at ? "" : "unread"}">
        <div class="metaRow">
          <span class="pill small">${escapeHtml(n.type)}</span>
          <span class="pill small">${fmtTs(n.created_at)}</span>
        </div>
        <div style="margin-top:6px;">${escapeHtml(n.message)}</div>
        <div class="inline" style="margin-top:10px;">
          ${n.entity==="gossip" && n.entity_id ? `<button onclick="openFromNotif(${n.id}, ${n.entity_id})">Abrir</button>` : ""}
          ${n.read_at ? "" : `<button class="ghost" onclick="markNotifRead(${n.id})">Marcar lida</button>`}
        </div>
      </div>
    `).join("") || `<div class="muted">Sem notifica√ß√µes.</div>`;
  }
}

async function openFromNotif(nid, gid){
  await markNotifRead(nid);
  await openGossip(gid);
  await refreshNotifications();
}

async function markNotifRead(nid){
  await api("/api/notifications/" + nid + "/read", { method:"POST" });
  await refreshNotifications();
  if(document.getElementById("notifPanel").style.display === "block"){
    await toggleNotifPanel();
    await toggleNotifPanel();
  }
}

async function fullRefresh(){
  await refreshHeaderAndStats();
  await refreshNotifications();
  await refreshList();
}

/* ===== Auth ===== */
document.getElementById("goRegisterBtn").onclick = () => setMode("register");
document.getElementById("backToLoginBtn").onclick = () => setMode("login");

document.getElementById("registerBtn").onclick = async () => {
  try{
    const name = document.getElementById("n").value.trim();
    const username = document.getElementById("u").value.trim();
    const password = document.getElementById("p").value;

    if(name.length < 2) return (document.getElementById("authMsg").textContent = "Nome m√≠nimo 2 caracteres.");
    if(username.length < 3) return (document.getElementById("authMsg").textContent = "Usu√°rio m√≠nimo 3 caracteres.");
    if(password.length < 4) return (document.getElementById("authMsg").textContent = "Senha m√≠nima 4 caracteres.");

    await api("/api/register", { method:"POST", body: JSON.stringify({name, username, password}) });
    document.getElementById("authMsg").textContent = `Conta criada, ${name}! Volte e fa√ßa login.`;
  }catch(e){
    document.getElementById("authMsg").textContent = e.message;
  }
};

document.getElementById("loginBtn").onclick = async () => {
  try{
    const username = document.getElementById("u").value.trim();
    const password = document.getElementById("p").value;

    if(!username || !password) return (document.getElementById("authMsg").textContent = "Preencha usu√°rio e senha.");

    const out = await api("/api/login", { method:"POST", body: JSON.stringify({username, password}) });
    TOKEN = out.token;

    setAuthUI(true);
    await fullRefresh();
    clearViewer();
  }catch(e){
    document.getElementById("authMsg").textContent = e.message;
  }
};

document.getElementById("logoutBtn").onclick = async () => {
  try{ await api("/api/logout", { method:"POST" }); }catch(e){}
  TOKEN = null; MY = null;
  setAuthUI(false);
  setMode("login");
  clearViewer();
};

document.getElementById("createBtn").onclick = create;
document.getElementById("refreshBtn").onclick = fullRefresh;
document.getElementById("applyBtn").onclick = refreshList;
document.getElementById("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshList(); });
document.getElementById("statusFilter").addEventListener("change", refreshList);
document.getElementById("sort").addEventListener("change", refreshList);

document.getElementById("tabFeed").onclick = ()=>setTab("feed");
document.getElementById("tabBacklog").onclick = ()=>setTab("backlog");

document.getElementById("deleteBtn").onclick = delSelected;
document.getElementById("moveBtn").onclick = openStatusModal;
document.getElementById("cSend").onclick = sendComment;

document.getElementById("bellBtn").onclick = toggleNotifPanel;

setMode("login");
clearViewer();
</script>
</body>
</html>
