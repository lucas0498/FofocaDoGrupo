<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FofocaDoGrupo ‚Äî GossipCRM</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --border:#1f2a37;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --btn:#143a63;
      --btn2:#153a2a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header{
      padding:16px 22px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }
    .brand{ font-weight:900; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:3px; }
    .right{ display:flex; align-items:center; gap:10px; }
    .pill{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      background:rgba(255,255,255,.02); color:var(--muted); font-size:12px;
    }

    button{
      cursor:pointer;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:var(--btn);
      color:#fff;
      padding:10px 14px;
      font-weight:800;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    button.secondary{ background:#0f2237; }
    button.green{ background:var(--btn2); border-color:#1f5b40; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    main{
      max-width:1400px;
      margin:18px auto;
      padding:0 18px 40px;
    }

    /* AUTH CENTRALIZADO */
    .authWrap{
      display:flex;
      justify-content:center;
      padding-top:18px;
    }
    .authCard{
      width:100%;
      max-width:860px;
    }
    .authGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    .authGrid .full{ grid-column:1 / -1; }

    .grid{
      display:grid;
      grid-template-columns: 420px minmax(420px, 1fr) 420px;
      gap:18px;
      align-items:start;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    h2{ margin:0 0 10px; }
    .muted{ color:var(--muted); font-size:12px; }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .sp{ height:10px; }
    .topline{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:999px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      color:#dbe5f0;
    }
    .tab.active{ background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.28); }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.20);
    }
    .kpi .n{ font-weight:900; font-size:20px; }
    .kpi .l{ color:var(--muted); font-size:11px; margin-top:2px; }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 62vh;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.20);
      padding:12px;
    }
    .item .t{ font-weight:900; }
    .item .meta{ color:var(--muted); font-size:12px; margin-top:4px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:inline-flex;
      align-items:center;
      gap:6px;
      line-height:1.4;
      user-select:none;
    }
    .badge.good{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.25); }
    .badge.warn{ background:rgba(234,179,8,.10); border-color:rgba(234,179,8,.22); }
    .badge.hot{ background:rgba(239,68,68,.10); border-color:rgba(239,68,68,.22); }
    .btnrow{ display:flex; gap:8px; margin-top:10px; }
    .danger{ background:#5b1622; }

    .hidden{ display:none !important; }

    .achWrap{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .achTitle{
      margin:12px 0 6px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .smallNote{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }
    .divider{
      border:0;border-top:1px solid rgba(255,255,255,.08);
      margin:12px 0;
    }

    /* Rea√ß√µes */
    .reactRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .reactBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:999px;
      padding:7px 10px;
      font-weight:900;
      display:inline-flex;
      gap:8px;
      align-items:center;
      cursor:pointer;
      box-shadow:none;
    }
    .reactBtn.active{
      background:rgba(34,197,94,.14);
      border-color:rgba(34,197,94,.28);
    }
    .reactCount{
      font-size:11px;
      color:var(--muted);
      font-weight:900;
      min-width:18px;
      text-align:center;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
    }

    /* Coment√°rios */
    .commentsWrap{
      margin-top:10px;
    }
    .commentsList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:260px;
      overflow:auto;
      padding-right:4px;
      margin-top:10px;
    }
    .commentItem{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(0,0,0,.18);
      padding:10px;
    }
    .commentTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
    }
    .commentBody{
      white-space:pre-wrap;
      font-size:13px;
      color:#dbe5f0;
    }
    .commentComposer{
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    .commentComposer textarea{
      min-height:72px;
    }

    @media (max-width: 1120px){
      .grid{ grid-template-columns: 1fr; }
      .list{ max-height: 40vh; }
      .authGrid{ grid-template-columns: 1fr; }
      .commentsList{ max-height:220px; }
    }
  </style>
</head>

<body>
<header>
  <div>
    <div class="brand">FofocaDoGrupo</div>
    <div class="sub">Fofoca Management ‚Ä¢ Observability ‚Ä¢ Compliance ‚Ä¢ Governan√ßa de Tias</div>
  </div>

  <div class="right">
    <span id="who" class="pill">N√£o logado</span>
    <button id="logoutBtn" class="secondary hidden">Sair</button>
  </div>
</header>

<main>
  <!-- AUTH -->
  <section id="authCard" class="authWrap">
    <div class="card authCard">
      <h2>Acesso</h2>
      <div class="muted">Crie sua conta e vire uma entidade do bairro. (Login sem email real)</div>

      <div class="sp"></div>
      <div id="authModeHint" class="muted">Modo: <b>Login</b></div>
      <div class="sp"></div>

      <div class="authGrid">
        <div class="full">
          <label class="muted">Usu√°rio</label>
          <input id="username" placeholder="ex: fofoqueiro2000" autocomplete="username"/>
        </div>

        <div id="nameBox" class="full hidden">
          <label class="muted">Nome</label>
          <input id="displayName" placeholder="ex: Fofoqueiro" autocomplete="name"/>
        </div>

        <div class="full">
          <label class="muted">Senha</label>
          <input id="password" placeholder="m√≠n. 6 caracteres" type="password" autocomplete="current-password"/>
        </div>

        <div class="full">
          <button id="loginBtn" style="width:100%;">Entrar</button>
        </div>

        <div class="full btnrow">
          <button id="toRegisterBtn" class="green" style="flex:1;">Criar conta</button>
          <button id="toLoginBtn" class="secondary hidden" style="flex:1;">Voltar para o login</button>
        </div>

        <div class="full">
          <div id="authMsg" class="muted"></div>
          <div class="sp"></div>
          <div class="muted">Dica: seu ‚Äúemail interno‚Äù vira <b>usuario@fofoca.local</b> automaticamente.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- APP -->
  <section class="grid hidden" id="appGrid">
    <!-- LEFT -->
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;">Dashboard</h2>
          <div class="muted" id="titleLine">T√≠tulo: ‚Äî</div>
        </div>
        <button id="refreshBtn">Atualizar</button>
      </div>

      <div class="sp"></div>

      <div class="tabs">
        <div class="tab active" id="tabFeed">Feed (grupo)</div>
        <div class="tab" id="tabMine">Meu Backlog</div>
        <div class="tab" id="tabProfile">Perfil</div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="n" id="kTotal">‚Äî</div><div class="l">Tickets totais (lista atual)</div></div>
        <div class="kpi"><div class="n" id="kConf">‚Äî</div><div class="l">CONFIRMADO</div></div>
        <div class="kpi"><div class="n" id="kApur">‚Äî</div><div class="l">APURA√á√ÉO</div></div>
        <div class="kpi"><div class="n" id="kArq">‚Äî</div><div class="l">ARQUIVADO</div></div>
      </div>

      <div class="achTitle">
        <div>Medalhas & Conquistas</div>
        <span class="badge" id="myLevelBadge">‚Äî</span>
      </div>
      <div class="achWrap" id="myBadges"></div>
      <div class="smallNote" id="nextHint">‚Äî</div>

      <hr class="divider"/>

      <h3 style="margin:12px 0 8px;">Nova ocorr√™ncia</h3>

      <label class="muted">T√≠tulo</label>
      <input id="newTitle" placeholder="Ex: Fulano foi visto com..." />
      <div class="sp"></div>

      <div class="row">
        <div>
          <label class="muted">Fonte</label>
          <input id="newSource" placeholder="Ex: zelador, grupo da fam√≠lia" />
        </div>
        <div>
          <label class="muted">Status</label>
          <select id="newStatus">
            <option value="APURACAO">APURA√á√ÉO</option>
            <option value="CONFIRMADO">CONFIRMADO</option>
            <option value="ARQUIVADO">ARQUIVADO</option>
          </select>
        </div>
      </div>

      <div class="sp"></div>

      <label class="muted">Detalhes</label>
      <textarea id="newDetails" placeholder="Descreva com seriedade corporativa... (use @usuario para mencionar)"></textarea>

      <div class="sp"></div>
      <div class="row">
        <div>
          <label class="muted">Confiabilidade (0‚Äì100)</label>
          <input id="newCred" type="number" min="0" max="100" value="50"/>
        </div>
        <div>
          <label class="muted">Tags (v√≠rgula)</label>
          <input id="newTags" placeholder="fonte confi√°vel, ouvi falar" />
        </div>
      </div>

      <div class="sp"></div>
      <button id="createBtn" class="green" style="width:100%;">Registrar ticket</button>
      <div id="createMsg" class="muted" style="margin-top:10px;"></div>
    </section>

    <!-- CENTER -->
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;">Explorar</h2>
          <div class="muted" id="exploreHint">Feed do grupo (todas as fofocas)</div>
        </div>
        <input id="search" placeholder="Pesquisar..." style="max-width:320px;"/>
      </div>

      <div class="sp"></div>
      <div class="list" id="list"></div>
      <div id="listMsg" class="muted" style="margin-top:10px;"></div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="topline">
        <h2 style="margin:0;">Visualiza√ß√£o</h2>
        <div class="muted">Detalhes + colabora√ß√£o</div>
      </div>

      <div class="sp"></div>

      <div id="detailsEmpty" class="muted">Selecione uma fofoca no feed/backlog para ver detalhes e colaborar.</div>

      <div id="detailsBox" class="hidden">
        <div class="item">
          <div class="t" id="dTitle">‚Äî</div>
          <div class="meta" id="dMeta"></div>
          <div class="sp"></div>
          <div id="dDetails" style="white-space:pre-wrap;"></div>
          <div class="sp"></div>
          <div class="meta" id="dTags"></div>

          <div class="sp"></div>
          <div class="muted"><b>Rea√ß√µes</b></div>
          <div class="reactRow" id="reactionsRow"></div>

          <div class="commentsWrap">
            <div class="sp"></div>
            <div class="muted"><b>Coment√°rios</b></div>
            <div class="commentsList" id="commentsList"></div>

            <div class="commentComposer">
              <textarea id="commentInput" placeholder="Escreva um coment√°rio‚Ä¶ (use @usuario)"></textarea>
              <button id="commentBtn" class="green">Comentar</button>
            </div>
            <div id="commentMsg" class="muted" style="margin-top:8px;"></div>
          </div>

          <div class="sp"></div>
          <div class="row">
            <div>
              <label class="muted">Mover status</label>
              <select id="moveStatus">
                <option value="APURACAO">APURA√á√ÉO</option>
                <option value="CONFIRMADO">CONFIRMADO</option>
                <option value="ARQUIVADO">ARQUIVADO</option>
              </select>
            </div>
            <div style="display:flex; align-items:end;">
              <button id="moveBtn" style="width:100%;">Mover</button>
            </div>
          </div>

          <div class="sp"></div>
          <div class="btnrow">
            <button id="delBtn" class="danger" style="flex:1;">Excluir (meu)</button>
          </div>

          <div id="dMsg" class="muted" style="margin-top:10px;"></div>
        </div>
      </div>

      <hr class="divider"/>

      <div class="item">
        <div class="t">Perfil r√°pido</div>
        <div class="meta" id="profileQuickMeta">
          <span class="badge">‚Äî</span>
        </div>
        <div class="sp"></div>
        <div class="achWrap" id="profileQuickBadges"></div>
        <div class="smallNote" id="profileQuickHint">‚Äî</div>
      </div>

    </section>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ======= CONFIG =======
  const SUPABASE_URL = "https://vguiwuiwgiuhtoifgjin.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZndWl3dWl3Z2l1aHRvaWZnamluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MzkwMjEsImV4cCI6MjA4NjIxNTAyMX0.EIGcLHCx0cYCAdobpAklR2MuKxpI7VQvcMIpYww3GMg";
  // ======================

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const authCard = document.getElementById('authCard');
  const appGrid  = document.getElementById('appGrid');
  const who      = document.getElementById('who');
  const logoutBtn= document.getElementById('logoutBtn');

  const usernameEl   = document.getElementById('username');
  const nameBox      = document.getElementById('nameBox');
  const displayNameEl= document.getElementById('displayName');
  const passwordEl   = document.getElementById('password');
  const authMsg      = document.getElementById('authMsg');
  const authModeHint = document.getElementById('authModeHint');

  const loginBtn     = document.getElementById('loginBtn');
  const toRegisterBtn= document.getElementById('toRegisterBtn');
  const toLoginBtn   = document.getElementById('toLoginBtn');

  const refreshBtn   = document.getElementById('refreshBtn');
  const createBtn    = document.getElementById('createBtn');
  const createMsg    = document.getElementById('createMsg');

  const tabFeed      = document.getElementById('tabFeed');
  const tabMine      = document.getElementById('tabMine');
  const tabProfile   = document.getElementById('tabProfile');
  const exploreHint  = document.getElementById('exploreHint');

  const listEl       = document.getElementById('list');
  const listMsg      = document.getElementById('listMsg');
  const searchEl     = document.getElementById('search');

  const kTotal = document.getElementById('kTotal');
  const kConf  = document.getElementById('kConf');
  const kApur  = document.getElementById('kApur');
  const kArq   = document.getElementById('kArq');

  const titleLine = document.getElementById('titleLine');

  const myLevelBadge = document.getElementById('myLevelBadge');
  const myBadges = document.getElementById('myBadges');
  const nextHint = document.getElementById('nextHint');

  const profileQuickMeta = document.getElementById('profileQuickMeta');
  const profileQuickBadges = document.getElementById('profileQuickBadges');
  const profileQuickHint = document.getElementById('profileQuickHint');

  const newTitle  = document.getElementById('newTitle');
  const newSource = document.getElementById('newSource');
  const newStatus = document.getElementById('newStatus');
  const newDetails= document.getElementById('newDetails');
  const newCred   = document.getElementById('newCred');
  const newTags   = document.getElementById('newTags');

  const detailsEmpty = document.getElementById('detailsEmpty');
  const detailsBox   = document.getElementById('detailsBox');
  const dTitle       = document.getElementById('dTitle');
  const dMeta        = document.getElementById('dMeta');
  const dDetails     = document.getElementById('dDetails');
  const dTags        = document.getElementById('dTags');
  const moveStatus   = document.getElementById('moveStatus');
  const moveBtn      = document.getElementById('moveBtn');
  const delBtn       = document.getElementById('delBtn');
  const dMsg         = document.getElementById('dMsg');

  // Intera√ß√µes
  const reactionsRow = document.getElementById('reactionsRow');
  const commentsList = document.getElementById('commentsList');
  const commentInput = document.getElementById('commentInput');
  const commentBtn   = document.getElementById('commentBtn');
  const commentMsg   = document.getElementById('commentMsg');

  let mode = 'feed';
  let selected = null;

  // Cache de gamifica√ß√£o por autor (pra mostrar t√≠tulo no feed)
  const authorStatsCache = new Map(); // user_id -> { count, title, badges, nextAt }
  let currentUserId = null;

  function showAuth(){
    authCard.classList.remove('hidden');
    appGrid.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    who.textContent = 'N√£o logado';
  }

  function showApp(label){
    authCard.classList.add('hidden');
    appGrid.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    who.textContent = label || 'Logado';
  }

  function normUsername(u){
    return (u||'').trim().toLowerCase().replace(/[^a-z0-9_]/g,'_');
  }
  function makeEmail(username){
    return username + "@fofoca.local";
  }

  function setAuthMode(isRegister){
    if(isRegister){
      authModeHint.innerHTML = 'Modo: <b>Criar conta</b>';
      nameBox.classList.remove('hidden');
      toLoginBtn.classList.remove('hidden');
      toRegisterBtn.classList.add('hidden');
      loginBtn.textContent = 'Criar e entrar';
    }else{
      authModeHint.innerHTML = 'Modo: <b>Login</b>';
      nameBox.classList.add('hidden');
      toLoginBtn.classList.add('hidden');
      toRegisterBtn.classList.remove('hidden');
      loginBtn.textContent = 'Entrar';
    }
    authMsg.textContent = '';
  }

  toRegisterBtn.onclick = () => setAuthMode(true);
  toLoginBtn.onclick = () => setAuthMode(false);

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function fmtTime(ts){
    try { return new Date(ts).toLocaleString(); }
    catch { return ts || ''; }
  }

  // ==========================
  // Gamification (T√≠tulos/Medalhas)
  // ==========================
  function gamifyByCount(count){
    const tiers = [
      { at: 0,   title: "Aprendiz de Fofoqueiro(a) ü™¥", badge: { label:"Primeira espiada", emoji:"ü™¥", cls:"good" } },
      { at: 3,   title: "Observador(a) Discreto(a) üïµÔ∏è", badge: { label:"J√° ouviu 3 vezes", emoji:"üïµÔ∏è", cls:"good" } },
      { at: 10,  title: "Fofoqueiro(a) de Plant√£o üó£Ô∏è", badge: { label:"10 ocorr√™ncias", emoji:"üó£Ô∏è", cls:"warn" } },
      { at: 20,  title: "Boca de Sacola Corporativa üì£", badge: { label:"20 ocorr√™ncias", emoji:"üì£", cls:"warn" } },
      { at: 40,  title: "Vov√≥zinha do Bairro üëµ", badge: { label:"40 ocorr√™ncias", emoji:"üëµ", cls:"hot" } },
      { at: 80,  title: "Lenda Urbana üèÜ", badge: { label:"80 ocorr√™ncias", emoji:"üèÜ", cls:"hot" } },
    ];

    let current = tiers[0];
    for(const t of tiers){
      if(count >= t.at) current = t;
    }

    const medals = [];
    const push = (ok, emoji, label, cls="") => { if(ok) medals.push({emoji, label, cls}); };

    push(count >= 1,  "‚úÖ", "Primeiro ticket", "good");
    push(count >= 5,  "ü•â", "Boca pequena", "good");
    push(count >= 15, "ü•à", "Fofoqueiro(a) s√≥lido(a)", "warn");
    push(count >= 30, "ü•á", "Alto impacto", "warn");
    push(count >= 60, "üíé", "Influ√™ncia no bairro", "hot");
    push(count >= 100,"üëë", "A lenda √© real", "hot");

    const nextTier = tiers.find(t => t.at > count);
    const nextAt = nextTier ? nextTier.at : null;
    const nextTitle = nextTier ? nextTier.title : null;

    return {
      title: current.title,
      tierBadge: current.badge,
      medals,
      nextAt,
      nextTitle,
    };
  }

  function renderBadges(container, badges){
    container.innerHTML = '';
    if(!badges || badges.length === 0){
      container.innerHTML = '<span class="badge">Sem medalhas ainda‚Ä¶ comece fofocando üòå</span>';
      return;
    }
    for(const b of badges){
      const span = document.createElement('span');
      span.className = 'badge ' + (b.cls || '');
      span.textContent = (b.emoji ? (b.emoji + " ") : "") + b.label;
      container.appendChild(span);
    }
  }

  function renderMyGamification(displayName, username, count){
    const g = gamifyByCount(count);

    myLevelBadge.className = "badge " + (g.tierBadge.cls || "");
    myLevelBadge.textContent = g.tierBadge.emoji + " " + g.tierBadge.label;

    renderBadges(myBadges, g.medals);

    if(g.nextAt !== null){
      nextHint.textContent = `Pr√≥ximo t√≠tulo em ${g.nextAt} fofocas ‚Üí ${g.nextTitle}`;
    }else{
      nextHint.textContent = "Voc√™ j√° atingiu o topo da cadeia alimentar do bairro. üëë";
    }

    titleLine.textContent =
      `T√≠tulo: ${g.title} ‚Ä¢ Fofoqueiro(a): ${displayName || '‚Äî'} (@${username || '‚Äî'}) ‚Ä¢ Fofocas: ${count}`;

    profileQuickMeta.innerHTML =
      `<span class="badge ${g.tierBadge.cls||''}">${escapeHtml(g.title)}</span>
       <span class="badge">Fofocas: ${count}</span>`;

    renderBadges(profileQuickBadges, g.medals);

    profileQuickHint.textContent =
      g.nextAt !== null
        ? `Pr√≥ximo n√≠vel: ${g.nextAt} fofocas.`
        : `Voc√™ zerou o bairro.`;
  }

  async function getMyGossipCount(userId){
    const { count, error } = await sb
      .from('gossips')
      .select('id', { count: 'exact', head: true })
      .eq('created_by', userId);

    if(error) throw error;
    return count || 0;
  }

  async function getAuthorGamification(authorId){
    if(authorStatsCache.has(authorId)) return authorStatsCache.get(authorId);

    const { count, error } = await sb
      .from('gossips')
      .select('id', { count: 'exact', head: true })
      .eq('created_by', authorId);

    if(error){
      const fallback = { count: 0, ...gamifyByCount(0) };
      authorStatsCache.set(authorId, fallback);
      return fallback;
    }

    const g = gamifyByCount(count || 0);
    const obj = { count: count || 0, ...g };
    authorStatsCache.set(authorId, obj);
    return obj;
  }

  async function hydrateAuthorTitles(rows){
    const ids = Array.from(new Set((rows||[]).map(r=>r.created_by).filter(Boolean)));
    const concurrency = 8;
    let i = 0;

    async function worker(){
      while(i < ids.length){
        const id = ids[i++];
        await getAuthorGamification(id);
      }
    }

    const workers = [];
    for(let w=0; w<Math.min(concurrency, ids.length); w++){
      workers.push(worker());
    }
    await Promise.all(workers);
  }

  // ==========================
  // Auth / Profile
  // ==========================
  async function ensureProfile(user, username, displayName){
    const { data: prof } = await sb
      .from('profiles')
      .select('id, username, display_name')
      .eq('id', user.id)
      .maybeSingle();

    if(prof) return prof;

    const payload = { id: user.id, username, display_name: displayName || username };
    const { data, error } = await sb.from('profiles').insert(payload).select().single();
    if(error) throw error;
    return data;
  }

  async function doLoginOrRegister(){
    authMsg.textContent = '';

    const username = normUsername(usernameEl.value);
    const password = passwordEl.value || '';
    const displayName = (displayNameEl?.value || '').trim();

    if(!username || username.length < 3){
      authMsg.textContent = 'Usu√°rio inv√°lido (m√≠n. 3). Use letras/n√∫meros/_';
      return;
    }
    if(password.length < 6){
      authMsg.textContent = 'Senha muito curta (m√≠n. 6).';
      return;
    }

    const email = makeEmail(username);

    try{
      if(loginBtn.textContent.includes('Criar')){
        const { data: su, error: eSU } = await sb.auth.signUp({
          email, password,
          options: { data: { username, display_name: displayName || username } }
        });
        if(eSU) throw eSU;

        if(!su.session){
          const { error: eSI2 } = await sb.auth.signInWithPassword({ email, password });
          if(eSI2) throw eSI2;
        }
      }else{
        const { error: eSI } = await sb.auth.signInWithPassword({ email, password });
        if(eSI) throw eSI;
      }

      const { data: ses } = await sb.auth.getSession();
      const user = ses?.session?.user;
      if(!user) throw new Error('Sem sess√£o. Verifique Email Confirm OFF no Supabase.');

      const prof = await ensureProfile(user, username, displayName || username);

      currentUserId = user.id;
      authorStatsCache.clear();

      showApp("Logado como: " + prof.display_name + " (@" + prof.username + ")");
      setAuthMode(false);
      await refresh();

    }catch(err){
      authMsg.textContent = err?.message || 'Erro de autentica√ß√£o';
    }
  }

  loginBtn.onclick = doLoginOrRegister;

  logoutBtn.onclick = async () => {
    await sb.auth.signOut();
    currentUserId = null;
    authorStatsCache.clear();
    showAuth();
  };

  function setActiveTab(el){
    [tabFeed, tabMine, tabProfile].forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
  }

  tabFeed.onclick = async () => { mode='feed'; setActiveTab(tabFeed); exploreHint.textContent='Feed do grupo (todas as fofocas)'; await refresh(); };
  tabMine.onclick = async () => { mode='mine'; setActiveTab(tabMine); exploreHint.textContent='Meu Backlog (s√≥ minhas fofocas)'; await refresh(); };
  tabProfile.onclick = async () => { mode='profile'; setActiveTab(tabProfile); exploreHint.textContent='Perfil (t√≠tulo + medalhas + minhas fofocas)'; await refresh(); };

  refreshBtn.onclick = refresh;

  // ==========================
  // Create
  // ==========================
  createBtn.onclick = async () => {
    createMsg.textContent = '';
    try{
      const { data: ses } = await sb.auth.getSession();
      const user = ses?.session?.user;
      if(!user){
        createMsg.textContent = 'Voc√™ precisa estar logado para registrar.';
        return;
      }

      const title = newTitle.value.trim();
      const source = newSource.value.trim();
      const details = newDetails.value.trim();
      const status = newStatus.value;
      const credibility = Math.max(0, Math.min(100, parseInt(newCred.value || '50', 10)));
      const tags = (newTags.value || '').split(',').map(s=>s.trim()).filter(Boolean);

      if(!title || !source || !details){
        createMsg.textContent = 'Preencha T√≠tulo, Fonte e Detalhes.';
        return;
      }

      const payload = { title, source, details, status, credibility, tags, created_by: user.id };
      const { error } = await sb.from('gossips').insert(payload);
      if(error) throw error;

      newTitle.value=''; newSource.value=''; newDetails.value=''; newTags.value=''; newCred.value='50'; newStatus.value='APURACAO';
      createMsg.textContent = 'Ticket registrado com excel√™ncia operacional. ‚úÖ';

      const cached = authorStatsCache.get(user.id);
      if(cached){
        const newCount = (cached.count || 0) + 1;
        authorStatsCache.set(user.id, { count: newCount, ...gamifyByCount(newCount) });
      }

      await refresh();

    }catch(err){
      createMsg.textContent = err?.message || 'Erro ao registrar';
    }
  };

  // ==========================
  // Intera√ß√µes: Rea√ß√µes + Coment√°rios
  // ==========================
  const REACTIONS = ["üëç","üòÇ","üòÆ","üî•","‚≠ê","üëé"];

  async function loadInteractions(gossipId){
    commentMsg.textContent = '';
    reactionsRow.innerHTML = '<span class="muted">Carregando‚Ä¶</span>';
    commentsList.innerHTML = '<span class="muted">Carregando‚Ä¶</span>';

    const { data: ses } = await sb.auth.getSession();
    const user = ses?.session?.user;
    const myId = user?.id;

    const reactionsPromise = sb
      .from('reactions')
      .select('id, reaction, user_id, created_at')
      .eq('gossip_id', gossipId);

    // embed do autor do coment√°rio via FK comments.user_id -> profiles.id
    const commentsPromise = sb
      .from('comments')
      .select('id, body, created_at, user_id, profiles(display_name, username)')
      .eq('gossip_id', gossipId)
      .order('created_at', { ascending: true });

    const [rRes, cRes] = await Promise.all([reactionsPromise, commentsPromise]);

    if(rRes.error){
      reactionsRow.innerHTML = `<span class="muted">${escapeHtml(rRes.error.message || 'Erro rea√ß√µes')}</span>`;
    } else {
      renderReactions(gossipId, rRes.data || [], myId);
    }

    if(cRes.error){
      commentsList.innerHTML = `<span class="muted">${escapeHtml(cRes.error.message || 'Erro coment√°rios')}</span>`;
    } else {
      renderComments(cRes.data || []);
    }
  }

  function renderReactions(gossipId, rows, myId){
    const counts = new Map();
    const mine = new Set();

    for(const r of rows){
      counts.set(r.reaction, (counts.get(r.reaction) || 0) + 1);
      if(myId && r.user_id === myId) mine.add(r.reaction);
    }

    reactionsRow.innerHTML = '';
    for(const emoji of REACTIONS){
      const btn = document.createElement('button');
      btn.className = 'reactBtn' + (mine.has(emoji) ? ' active' : '');
      btn.type = 'button';

      const c = counts.get(emoji) || 0;
      btn.innerHTML = `<span style="font-size:15px;">${emoji}</span> <span class="reactCount">${c}</span>`;
      btn.onclick = async () => {
        await toggleReaction(gossipId, emoji);
      };
      reactionsRow.appendChild(btn);
    }

    // extra: total de rea√ß√µes
    const total = Array.from(counts.values()).reduce((a,b)=>a+b,0);
    const totalSpan = document.createElement('span');
    totalSpan.className = 'badge';
    totalSpan.textContent = `Total: ${total}`;
    reactionsRow.appendChild(totalSpan);
  }

  async function toggleReaction(gossipId, emoji){
    try{
      const { data: ses } = await sb.auth.getSession();
      const user = ses?.session?.user;
      if(!user){
        commentMsg.textContent = 'Voc√™ precisa estar logado.';
        return;
      }

      // existe rea√ß√£o desse usu√°rio nesse emoji?
      const { data: existing, error: e1 } = await sb
        .from('reactions')
        .select('id')
        .eq('gossip_id', gossipId)
        .eq('user_id', user.id)
        .eq('reaction', emoji);

      if(e1) throw e1;

      if(existing && existing.length > 0){
        // remove (toggle off)
        const ids = existing.map(x=>x.id);
        const { error: eDel } = await sb.from('reactions').delete().in('id', ids);
        if(eDel) throw eDel;
      }else{
        // adiciona (toggle on)
        const { error: eIns } = await sb.from('reactions').insert({
          gossip_id: gossipId,
          user_id: user.id,
          reaction: emoji
        });
        if(eIns) throw eIns;
      }

      // recarrega intera√ß√µes do detalhe
      await loadInteractions(gossipId);

      // atualiza cards (se sua view computa contagens)
      await refresh(true);

    }catch(err){
      commentMsg.textContent = err?.message || 'Erro ao reagir';
    }
  }

  function renderComments(rows){
    commentsList.innerHTML = '';
    if(rows.length === 0){
      commentsList.innerHTML = '<span class="muted">Sem coment√°rios ainda‚Ä¶ seja o primeiro a opinar üëÄ</span>';
      return;
    }

    for(const c of rows){
      const prof = c.profiles || {};
      const name = prof.display_name || '‚Äî';
      const usern = prof.username || '‚Äî';

      const div = document.createElement('div');
      div.className = 'commentItem';
      div.innerHTML = `
        <div class="commentTop">
          <div><b>${escapeHtml(name)}</b> <span class="muted">(@${escapeHtml(usern)})</span></div>
          <div class="muted">${escapeHtml(fmtTime(c.created_at))}</div>
        </div>
        <div class="commentBody">${escapeHtml(c.body || '')}</div>
      `;
      commentsList.appendChild(div);
    }

    // scroll pro final (√∫ltimo coment√°rio)
    commentsList.scrollTop = commentsList.scrollHeight;
  }

  commentBtn.onclick = async () => {
    commentMsg.textContent = '';
    try{
      if(!selected){
        commentMsg.textContent = 'Selecione uma fofoca primeiro.';
        return;
      }
      const body = (commentInput.value || '').trim();
      if(!body){
        commentMsg.textContent = 'Digite um coment√°rio.';
        return;
      }

      const { data: ses } = await sb.auth.getSession();
      const user = ses?.session?.user;
      if(!user){
        commentMsg.textContent = 'Voc√™ precisa estar logado.';
        return;
      }

      const { error } = await sb.from('comments').insert({
        gossip_id: selected.id,
        user_id: user.id,
        body
      });
      if(error) throw error;

      commentInput.value = '';
      commentMsg.textContent = 'Coment√°rio enviado ‚úÖ';

      await loadInteractions(selected.id);
      await refresh(true);

    }catch(err){
      commentMsg.textContent = err?.message || 'Erro ao comentar';
    }
  };

  // ==========================
  // List / Render
  // ==========================
  searchEl.oninput = () => renderList(window.__lastRows || []);

  function renderList(rows){
    const q = (searchEl.value || '').toLowerCase().trim();
    const filtered = !q ? rows : rows.filter(r =>
      (r.title||'').toLowerCase().includes(q) ||
      (r.details||'').toLowerCase().includes(q) ||
      (r.source||'').toLowerCase().includes(q) ||
      (r.author_username||'').toLowerCase().includes(q) ||
      (r.author_display_name||'').toLowerCase().includes(q)
    );

    listEl.innerHTML = '';
    if(filtered.length === 0){
      listMsg.textContent = 'Nada por aqui ainda.';
      return;
    }
    listMsg.textContent = '';

    for(const r of filtered){
      const div = document.createElement('div');
      div.className='item';

      const preview = (r.details || '').split('\n').slice(0,2).join('\n');
      const tags = (r.tags || []).slice(0,3).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join(' ');

      const authorG = authorStatsCache.get(r.created_by);
      const authorTitle = authorG ? authorG.title : "‚Äî";

      div.innerHTML = `
        <div class="t">${escapeHtml(r.title)}</div>
        <div class="meta">
          <span class="badge">${escapeHtml(r.status)}</span>
          <span class="badge">Cred ${r.credibility}</span>
          <span class="badge">Por: ${escapeHtml(r.author_display_name || '‚Äî')} (@${escapeHtml(r.author_username || '‚Äî')})</span>
          <span class="badge">${escapeHtml(authorTitle)}</span>
          <span class="badge">üí¨ ${r.comment_count || 0}</span>
        </div>
        <div class="sp"></div>
        <div style="white-space:pre-wrap; color:#cdd6e1; font-size:13px;">${escapeHtml(preview)}${(r.details||'').includes('\n') ? '‚Ä¶' : ''}</div>
        <div class="sp"></div>
        <div class="meta">${tags}</div>
        <div class="sp"></div>
        <div class="btnrow">
          <button class="secondary" data-open="1">Abrir</button>
        </div>
      `;
      div.querySelector('[data-open="1"]').onclick = () => setSelected(r);
      listEl.appendChild(div);
    }
  }

  async function setSelected(row){
    selected = row;
    detailsEmpty.classList.add('hidden');
    detailsBox.classList.remove('hidden');
    dMsg.textContent='';
    commentMsg.textContent='';

    dTitle.textContent = row.title;
    dDetails.textContent = row.details;

    const meta = [];
    meta.push('<span class="badge">' + row.status + '</span>');
    meta.push('<span class="badge">Cred ' + row.credibility + '</span>');
    meta.push('<span class="badge">Por: ' + (escapeHtml(row.author_display_name || '‚Äî')) + ' (@' + (escapeHtml(row.author_username || '‚Äî')) + ')</span>');

    const authorG = authorStatsCache.get(row.created_by);
    if(authorG) meta.push('<span class="badge">' + escapeHtml(authorG.title) + '</span>');

    meta.push('<span class="badge">' + escapeHtml(fmtTime(row.created_at)) + '</span>');
    dMeta.innerHTML = meta.join(' ');

    dTags.innerHTML = (row.tags || []).map(t=>'<span class="badge">' + escapeHtml(t) + '</span>').join(' ');
    moveStatus.value = row.status;

    delBtn.disabled = !row.is_mine;
    moveBtn.disabled = !row.is_mine;

    await loadInteractions(row.id);
  }

  // ==========================
  // Actions: move / delete
  // ==========================
  moveBtn.onclick = async () => {
    if(!selected) return;
    dMsg.textContent='';
    try{
      const to = moveStatus.value;
      const { error } = await sb.from('gossips').update({ status: to }).eq('id', selected.id);
      if(error) throw error;
      dMsg.textContent='Status atualizado.';
      await refresh(true);
    }catch(err){
      dMsg.textContent = err?.message || 'Erro ao mover';
    }
  };

  delBtn.onclick = async () => {
    if(!selected) return;
    dMsg.textContent='';
    try{
      const { error } = await sb.from('gossips').delete().eq('id', selected.id);
      if(error) throw error;
      dMsg.textContent='Exclu√≠do.';
      selected = null;
      detailsBox.classList.add('hidden');
      detailsEmpty.classList.remove('hidden');
      await refresh();
    }catch(err){
      dMsg.textContent = err?.message || 'Erro ao excluir';
    }
  };

  // ==========================
  // Refresh
  // ==========================
  async function refresh(keepSelected=false){
    listMsg.textContent = '';
    createMsg.textContent = '';

    const { data: ses } = await sb.auth.getSession();
    const user = ses?.session?.user;
    if(!user){
      showAuth();
      return;
    }
    currentUserId = user.id;

    const { data: prof } = await sb
      .from('profiles')
      .select('username, display_name')
      .eq('id', user.id)
      .maybeSingle();

    const displayName = prof?.display_name || '‚Äî';
    const username = prof?.username || '‚Äî';

    showApp("Logado como: " + displayName + " (@" + username + ")");

    let myCount = 0;
    try{
      myCount = await getMyGossipCount(user.id);
      authorStatsCache.set(user.id, { count: myCount, ...gamifyByCount(myCount) });
    }catch(e){
      myCount = 0;
      authorStatsCache.set(user.id, { count: 0, ...gamifyByCount(0) });
    }
    renderMyGamification(displayName, username, myCount);

    let q = sb.from('gossip_cards').select('*').order('created_at', { ascending:false }).limit(50);
    if(mode === 'mine' || mode === 'profile') q = q.eq('created_by', user.id);

    const { data: rows, error } = await q;
    if(error){
      listMsg.textContent = error.message || 'Erro ao carregar feed';
      return;
    }

    const rows2 = (rows || []).map(r => ({...r, is_mine: (r.created_by === user.id)}));
    window.__lastRows = rows2;

    const total = rows2.length;
    const conf  = rows2.filter(r=>r.status==='CONFIRMADO').length;
    const apur  = rows2.filter(r=>r.status==='APURACAO').length;
    const arq   = rows2.filter(r=>r.status==='ARQUIVADO').length;

    kTotal.textContent = total;
    kConf.textContent = conf;
    kApur.textContent = apur;
    kArq.textContent = arq;

    await hydrateAuthorTitles(rows2);

    renderList(rows2);

    if(mode === 'profile'){
      exploreHint.textContent = `Perfil de ${displayName} (@${username}) ‚Ä¢ T√≠tulo e medalhas acima`;
    }

    if(keepSelected && selected){
      const again = rows2.find(r=>r.id === selected.id);
      if(again) await setSelected(again);
    }
  }

  (async () => {
    setAuthMode(false);

    const { data: ses } = await sb.auth.getSession();
    if(ses?.session?.user) await refresh();
    else showAuth();

    sb.auth.onAuthStateChange(async (event, session) => {
      if(session?.user) await refresh();
      else showAuth();
    });
  })();
</script>
</body>
</html>
