<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FofocaDoGrupo ‚Äî Fofoca Management</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0f14; color: #e6edf3; }
    header { padding: 18px 22px; border-bottom: 1px solid #1f2a37; display:flex; gap:12px; align-items:center; }
    .brand { font-weight: 800; letter-spacing: 0.5px; }
    .tagline { opacity: .75; font-size: 12px; }
    .spacer { flex:1; }
    .topright { display:flex; gap:10px; align-items:center; }
    .pill { border: 1px solid #243244; background:#0f1620; padding: 8px 10px; border-radius: 12px; font-size: 12px; opacity: .92; }
    main { display: grid; grid-template-columns: 420px 1fr; gap: 16px; padding: 16px; }
    @media (max-width: 980px){
      main { grid-template-columns: 1fr; }
    }
    .card { background: #0f1620; border: 1px solid #1f2a37; border-radius: 14px; padding: 14px; }
    .muted { opacity: .7; font-size: 12px; }
    input, textarea, select, button {
      width: 100%; box-sizing: border-box; padding: 10px 10px; border-radius: 10px;
      border: 1px solid #243244; background: #0b111a; color: #e6edf3; outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    button { cursor: pointer; background: #16324f; border-color: #274d78; font-weight: 650; }
    button.secondary { background:#0b111a; border-color:#243244; font-weight: 650; }
    button.success { background:#153a2a; border-color:#1f5b40; }
    button.danger { background:#3a1520; border-color:#6b2433; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .inline { display:flex; gap:10px; }
    .inline > * { flex:1; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-flex; gap:6px; align-items:center; border:1px solid #243244; background:#0b111a; padding: 4px 8px; border-radius: 999px; font-size: 12px; opacity:.95; }
    .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .kpi .mini { background:#0b111a; border:1px solid #243244; border-radius: 12px; padding: 10px; }
    .kpi .mini .n { font-size: 20px; font-weight: 800; line-height: 1.1; }
    .kpi .mini .t { font-size: 11px; opacity:.75; }
    .list { display:flex; flex-direction: column; gap:10px; }
    .item { background:#0b111a; border:1px solid #243244; border-radius: 14px; padding: 12px; }
    .item h4 { margin:0 0 6px 0; font-size: 14px; }
    .item .meta { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .item .preview { margin-top: 8px; opacity:.9; font-size: 12px; line-height: 1.3; white-space: pre-line; }
    .btnRow { margin-top: 10px; display:flex; gap:10px; }
    .btnRow button { width:auto; padding: 8px 10px; }
    .split { display:grid; grid-template-columns: 1fr 380px; gap: 16px; }
    @media (max-width: 1100px){
      .split { grid-template-columns: 1fr; }
    }
    .hr { height:1px; background:#1f2a37; margin: 12px 0; }
    .mention { color:#8ad1ff; font-weight: 650; }
    .reactBar { display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .reactBtn { width:auto; padding: 6px 10px; font-size: 12px; border-radius: 999px; background:#0f1620; border-color:#243244; }
    .reactBtn.on { background:#1b2b3a; border-color:#3b6fa3; }
    .tabs { display:flex; gap:10px; align-items:center; }
    .tabs button { width:auto; padding: 8px 10px; border-radius: 999px; }
    .tabs button.active { background:#153a2a; border-color:#1f5b40; }
    .rightTop { display:flex; align-items:center; justify-content:space-between; gap: 10px; flex-wrap:wrap; }
  </style>
</head>

<body>
<header>
  <div>
    <div class="brand">FofocaDoGrupo</div>
    <div class="tagline">Fofoca Management ‚Ä¢ Observability ‚Ä¢ Compliance ‚Ä¢ Governan√ßa de Tias</div>
  </div>
  <div class="spacer"></div>
  <div class="topright">
    <div class="pill" id="who">N√£o logado</div>
    <button id="logoutBtn" class="secondary" style="width:auto; display:none;">Sair</button>
  </div>
</header>

<main>
  <!-- AUTH -->
  <section class="card" id="authCard">
    <h2 style="margin-top:0;">Acesso</h2>
    <div class="muted">Crie sua conta e vire uma entidade do bairro. (Login sem email real)</div>

    <div style="height:10px"></div>

    <div id="authLoginFields">
      <input id="u" placeholder="Usu√°rio (ex: Fofoqueiro2000)" autocomplete="username"/>
      <div style="height:10px"></div>
      <input id="p" placeholder="Senha" type="password" autocomplete="current-password"/>
    </div>

    <div id="authRegisterFields" style="display:none;">
      <input id="r_u" placeholder="Login (ex: Fofoqueiro2000)" autocomplete="username"/>
      <div style="height:10px"></div>
      <input id="r_name" placeholder="Nome (ex: Fofoqueiro)" autocomplete="name"/>
      <div style="height:10px"></div>
      <input id="r_p" placeholder="Senha (m√≠n. 6)" type="password" autocomplete="new-password"/>
    </div>

    <div style="height:10px"></div>

    <button id="loginBtn">Entrar</button>

    <div class="inline" style="margin-top:10px;">
      <button id="goRegisterBtn" class="success">Criar conta</button>
      <button id="backToLoginBtn" class="secondary" style="display:none;">Voltar para o login</button>
    </div>

    <div id="authMsg" class="muted" style="margin-top:10px;"></div>

    <div class="hr"></div>
    <div class="muted">
      Compartilhe todas as fofocas sem modera√ß√£o
    </div>
  </section>

  <!-- APP -->
  <section class="card" id="appCard" style="display:none;">
    <div class="rightTop">
      <div>
        <h2 style="margin:0;">Dashboard</h2>
        <div class="muted" id="profileLine">Carregando perfil‚Ä¶</div>
      </div>
      <div class="tabs">
        <button id="tabFeed" class="active">Feed (grupo)</button>
        <button id="tabMine" class="secondary">Meu Backlog</button>
        <button id="tabProfile" class="secondary">Perfil</button>
        <button id="refreshBtn" style="width:auto;">Atualizar</button>
      </div>
    </div>

    <div style="height:12px;"></div>

    <div class="kpi">
      <div class="mini"><div class="n" id="k_total">0</div><div class="t">Tickets totais</div></div>
      <div class="mini"><div class="n" id="k_confirm">0</div><div class="t">CONFIRMADO</div></div>
      <div class="mini"><div class="n" id="k_apu">0</div><div class="t">APURA√á√ÉO</div></div>
      <div class="mini"><div class="n" id="k_arch">0</div><div class="t">ARQUIVADO</div></div>
    </div>

    <div class="hr"></div>

    <div class="split">
      <!-- esquerda: cria√ß√£o + lista -->
      <div>
        <h3 style="margin:0 0 10px 0;">Nova ocorr√™ncia</h3>

        <div class="inline">
          <div>
            <label class="muted">T√≠tulo</label>
            <input id="title" placeholder="Ex: Fulano foi visto..." />
          </div>
          <div>
            <label class="muted">Fonte</label>
            <input id="source" placeholder="Ex: zelador, grupo da fam√≠lia" />
          </div>
        </div>

        <div style="height:10px;"></div>
        <label class="muted">Detalhes</label>
        <textarea id="details" placeholder="Descreva com seriedade corporativa... (use @usuario pra mencionar)"></textarea>

        <div style="height:10px;"></div>
        <div class="inline">
          <div>
            <label class="muted">Status</label>
            <select id="status">
              <option value="APURACAO">APURA√á√ÉO</option>
              <option value="CONFIRMADO">CONFIRMADO</option>
              <option value="ARQUIVADO">ARQUIVADO</option>
            </select>
          </div>
          <div>
            <label class="muted">Confiabilidade (0‚Äì100)</label>
            <input id="cred" type="number" min="0" max="100" value="50"/>
          </div>
        </div>

        <div style="height:10px;"></div>
        <label class="muted">Tags (separadas por v√≠rgula)</label>
        <input id="tags" placeholder="fonte confi√°vel, ouvi falar, primo do amigo"/>

        <div style="height:12px;"></div>
        <button id="createBtn">Registrar ticket</button>
        <div id="msg" class="muted" style="margin-top:10px;"></div>

        <div class="hr"></div>

        <h3 style="margin:0 0 10px 0;" id="listTitle">Explorar</h3>
        <div class="muted" id="listHint" style="margin-bottom:10px;">Clique em ‚ÄúAbrir‚Äù para detalhes e colabora√ß√£o.</div>
        <div class="list" id="list"></div>
      </div>

      <!-- direita: detalhes + coment√°rios -->
      <div>
        <h3 style="margin:0 0 10px 0;">Visualiza√ß√£o</h3>
        <div class="muted">Selecione uma fofoca no feed/backlog para detalhes e colabora√ß√£o.</div>

        <div class="hr"></div>

        <div id="detailEmpty" class="muted">Nenhuma fofoca selecionada.</div>

        <div id="detailWrap" style="display:none;">
          <div class="row" style="justify-content:space-between;">
            <div class="meta" id="detailMeta"></div>
            <button id="closeDetailBtn" class="secondary" style="width:auto;">Fechar</button>
          </div>

          <h3 id="detailTitle" style="margin:10px 0 6px 0;"></h3>
          <div class="muted" id="detailBy"></div>

          <div class="preview" id="detailText" style="margin-top:10px; white-space:pre-line;"></div>

          <div class="reactBar" id="detailReacts"></div>

          <div class="hr"></div>

          <div class="inline">
            <select id="moveStatusSelect">
              <option value="APURACAO">APURA√á√ÉO</option>
              <option value="CONFIRMADO">CONFIRMADO</option>
              <option value="ARQUIVADO">ARQUIVADO</option>
            </select>
            <button id="moveStatusBtn" style="width:auto;">Mover status</button>
          </div>

          <div class="btnRow">
            <button id="deleteBtn" class="danger" style="display:none;">Excluir (meu ticket)</button>
          </div>

          <div class="hr"></div>

          <h4 style="margin:0 0 8px 0;">Coment√°rios</h4>
          <div class="list" id="comments"></div>

          <div style="height:10px;"></div>
          <textarea id="commentBody" placeholder="Comente... (use @usuario para mencionar)"></textarea>
          <div style="height:10px;"></div>
          <button id="commentBtn">Comentar</button>
          <div id="commentMsg" class="muted" style="margin-top:8px;"></div>
        </div>

        <div id="profileWrap" style="display:none;">
          <h3 style="margin:0 0 10px 0;">Perfil</h3>
          <div class="item">
            <div class="meta" id="profileBadges"></div>
            <div class="hr"></div>
            <div class="muted" id="profileStats"></div>
          </div>

          <div style="height:12px;"></div>
          <h4 style="margin:0 0 10px 0;">Fofocas do usu√°rio</h4>
          <div class="list" id="profileList"></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ======= CONFIG =======
  const SUPABASE_URL = "https://vguiwuiwgiuhtoifgjin.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZndWl3dWl3Z2l1aHRvaWZnamluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MzkwMjEsImV4cCI6MjA4NjIxNTAyMX0.EIGcLHCx0cYCAdobpAklR2MuKxpI7VQvcMIpYww3GMg";

  if (!window.supabase || !window.supabase.createClient) {
    throw new Error("Supabase JS n√£o carregou. Verifique se o <script src='@supabase/supabase-js@2'> est√° antes do seu script.");
  }

  // Client √∫nico do Supabase (use sb.* em TODO lugar)
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ======= STATE =======
  let session = null;
  let me = null; // profile row
  let mode = "feed"; // feed | mine | profile
  let selected = null; // selected gossip card
  const REACTIONS = ["üëç","üòÇ","üòÆ","üò°","üî•","‚≠ê"];

  // ======= HELPERS =======
  const $ = (id) => document.getElementById(id);

  function usernameToEmail(u){
    return (u || "").trim().toLowerCase() + "@fofoca.local";
  }

  function cleanUsername(u){
    return (u || "").trim().toLowerCase().replace(/\s+/g,"_");
  }

  function titleFromCount(n){
    if(n >= 30) return "Lenda Urbana Oficial üèÜ";
    if(n >= 15) return "Vov√≥zinha do bairro ‚òï";
    if(n >= 7) return "Rep√≥rter do Port√£o üì∞";
    if(n >= 3) return "Observador(a) Discreto(a) üëÄ";
    return "Aprendiz de Fofoqueiro(a) üå±";
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function withMentions(text){
    const safe = escapeHtml(text);
    return safe.replace(/(^|[\s(])@([a-zA-Z0-9_]{2,32})/g, (m, p1, u) => {
      return `${p1}<span class="mention">@${u}</span>`;
    });
  }

  function twoLinePreview(text){
    const lines = (text || "").split(/\r?\n/);
    const preview = lines.slice(0, 2).join("\n");
    return preview.length > 220 ? preview.slice(0, 220) + "‚Ä¶" : preview;
  }

  function setAuthUI(logged){
    $("authCard").style.display = logged ? "none" : "block";
    $("appCard").style.display = logged ? "block" : "none";
    $("logoutBtn").style.display = logged ? "inline-block" : "none";
    $("who").textContent = logged
      ? `Logado como: ${me?.display_name || "Usu√°rio"} (@${me?.username || "?"})`
      : "N√£o logado";
  }

  function setMsg(el, text){
    $(el).textContent = text || "";
  }

  function setActiveTab(){
    $("tabFeed").classList.toggle("active", mode==="feed");
    $("tabMine").classList.toggle("active", mode==="mine");
    $("tabProfile").classList.toggle("active", mode==="profile");
    $("tabFeed").classList.toggle("secondary", mode!=="feed");
    $("tabMine").classList.toggle("secondary", mode!=="mine");
    $("tabProfile").classList.toggle("secondary", mode!=="profile");
  }

  function showDetail(show){
    $("detailEmpty").style.display = show ? "none" : "block";
    $("detailWrap").style.display = show ? "block" : "none";
  }

  function showProfile(show){
    $("profileWrap").style.display = show ? "block" : "none";
  }

  function showDetailArea(){
    if(mode === "profile"){
      showDetail(false);
      showProfile(true);
    } else {
      showProfile(false);
      if(selected) showDetail(true);
      else showDetail(false);
    }
  }

  function setRegisterMode(on){
    $("authLoginFields").style.display = on ? "none" : "block";
    $("authRegisterFields").style.display = on ? "block" : "none";
    $("loginBtn").disabled = on;
    $("backToLoginBtn").style.display = on ? "block" : "none";
    $("goRegisterBtn").textContent = on ? "Criar conta (confirmar)" : "Criar conta";
    setMsg("authMsg", on ? "Modo cadastro: preencha Login, Nome e Senha." : "");
  }

  // ======= AUTH MODE (login/register toggle) =======
  $("goRegisterBtn").onclick = async () => {
    // Se N√ÉO est√° em modo cadastro, liga o modo cadastro
    if($("authRegisterFields").style.display === "none"){
      setRegisterMode(true);
      return;
    }
    // Se j√° est√° em modo cadastro, confirma o cadastro
    await register();
  };

  $("backToLoginBtn").onclick = () => {
    setRegisterMode(false);
  };

  $("loginBtn").onclick = async () => {
    try{
      setMsg("authMsg","");
      const username = cleanUsername($("u").value);
      const password = $("p").value;

      if(!username || username.length < 3) throw new Error("Usu√°rio inv√°lido (min 3 chars).");
      if(!password || password.length < 6) throw new Error("Senha inv√°lida (min 6 chars).");

      const email = usernameToEmail(username);

      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if(error) throw error;

      session = data.session;
      await loadMe();
      setAuthUI(true);
      await refreshAll();
    }catch(e){
      setMsg("authMsg", e?.message || "Erro ao entrar.");
    }
  };

  $("logoutBtn").onclick = async () => {
    await sb.auth.signOut();
    session = null;
    me = null;
    selected = null;
    setAuthUI(false);
  };

  async function register(){
    try{
      setMsg("authMsg","");
      const username = cleanUsername($("r_u").value);
      const display_name = ($("r_name").value || "").trim();
      const password = $("r_p").value;

      if(!username || username.length < 3) throw new Error("Login inv√°lido (min 3 chars).");
      if(!display_name || display_name.length < 2) throw new Error("Nome inv√°lido (min 2 chars).");
      if(!password || password.length < 6) throw new Error("Senha inv√°lida (min 6 chars).");

      const email = usernameToEmail(username);

      const { error } = await sb.auth.signUp({
        email,
        password,
        options: {
          data: { username, display_name }
        }
      });
      if(error) throw error;

      // volta pro login e j√° preenche o user
      $("u").value = username;
      $("p").value = "";
      setRegisterMode(false);
      setMsg("authMsg", "Conta criada! Agora fa√ßa login üòä");
    }catch(e){
      setMsg("authMsg", e?.message || "Erro ao criar conta.");
    }
  }

  // ======= LOAD PROFILE =======
  async function loadMe(){
    const { data: { user } } = await sb.auth.getUser();
    if(!user) throw new Error("Sess√£o inv√°lida.");

    // profiles √© criada por trigger no signup; mas pode demorar um pouco
    const { data, error } = await sb
      .from("profiles")
      .select("id, username, display_name, created_at")
      .eq("id", user.id)
      .maybeSingle();

    if(error) throw error;

    if(!data){
      // fallback: tenta criar (caso trigger n√£o tenha rodado)
      const metaU = user.user_metadata?.username || user.email?.split("@")[0] || "usuario";
      const metaN = user.user_metadata?.display_name || "Usu√°rio";
      const ins = await sb.from("profiles").insert({
        id: user.id,
        username: metaU.toLowerCase(),
        display_name: metaN
      });
      if(ins.error) throw ins.error;

      const again = await sb.from("profiles").select("*").eq("id", user.id).single();
      if(again.error) throw again.error;
      me = again.data;
    } else {
      me = data;
    }

    $("profileLine").textContent = `T√≠tulo: ${titleFromCount(await countMine())} ‚Ä¢ Fofoqueiro(a): ${me.display_name} (@${me.username})`;
  }

  async function countMine(){
    const { data: { user } } = await sb.auth.getUser();
    const uid = user?.id;
    if(!uid) return 0;
    const { count, error } = await sb.from("gossips").select("id", { count:"exact", head:true }).eq("created_by", uid);
    if(error) return 0;
    return count || 0;
  }

  // ======= DATA =======
  async function createGossip(){
    try{
      setMsg("msg","");
      const { data: { user } } = await sb.auth.getUser();
      const uid = user?.id;
      if(!uid) throw new Error("Voc√™ n√£o est√° logado.");

      const title = ($("title").value || "").trim();
      const source = ($("source").value || "").trim() || "an√¥nimo corporativo";
      const details = ($("details").value || "").trim();
      const status = $("status").value;
      const credibility = Math.max(0, Math.min(100, parseInt($("cred").value || "50", 10)));
      const tags = ($("tags").value || "")
        .split(",")
        .map(s => s.trim())
        .filter(Boolean);

      if(title.length < 4) throw new Error("T√≠tulo muito curto.");
      if(details.length < 6) throw new Error("Detalhes muito curtos.");

      const { error } = await sb.from("gossips").insert({
        title, source, details, status, credibility, tags,
        created_by: uid
      });
      if(error) throw error;

      $("title").value = "";
      $("source").value = "";
      $("details").value = "";
      $("tags").value = "";
      $("cred").value = "50";
      $("status").value = "APURACAO";

      setMsg("msg", "Ticket registrado com excel√™ncia operacional.");
      await refreshAll(true);
    }catch(e){
      setMsg("msg", e?.message || "Erro ao registrar.");
    }
  }

  $("createBtn").onclick = createGossip;
  $("refreshBtn").onclick = () => refreshAll(true);

  $("tabFeed").onclick = async () => {
    mode="feed"; selected=null;
    setActiveTab(); await refreshAll(true);
  };
  $("tabMine").onclick = async () => {
    mode="mine"; selected=null;
    setActiveTab(); await refreshAll(true);
  };
  $("tabProfile").onclick = async () => {
    mode="profile"; selected=null;
    setActiveTab(); await refreshAll(true);
  };

  async function fetchCards(){
    // Usa view gossip_cards (j√° agrega autor, contagem de comments e reactions)
    let q = sb
      .from("gossip_cards")
      .select("*")
      .order("created_at", { ascending:false })
      .limit(60);

    if(mode === "mine"){
      const { data: { user } } = await sb.auth.getUser();
      q = q.eq("created_by", user.id);
    }

    const res = await q;
    if(res.error) throw res.error;
    return res.data || [];
  }

  function renderList(cards){
    const list = $("list");
    list.innerHTML = "";

    if(mode === "feed"){
      $("listTitle").textContent = "Explorar";
      $("listHint").textContent = "Feed do grupo (todas as fofocas). Abra para comentar e reagir.";
    } else if(mode === "mine"){
      $("listTitle").textContent = "Meu Backlog";
      $("listHint").textContent = "Apenas as suas fofocas. Voc√™ pode mover status e excluir.";
    } else {
      $("listTitle").textContent = "Explorar";
      $("listHint").textContent = "";
    }

    if(cards.length === 0){
      const empty = document.createElement("div");
      empty.className = "muted";
      empty.textContent = "Nada por aqui ainda‚Ä¶";
      list.appendChild(empty);
      return;
    }

    for(const g of cards){
      const el = document.createElement("div");
      el.className = "item";

      const metaBadges = [];
      metaBadges.push(`<span class="badge">${escapeHtml(g.status)}</span>`);
      metaBadges.push(`<span class="badge">Cred ${escapeHtml(g.credibility)}</span>`);
      metaBadges.push(`<span class="badge">üí¨ ${escapeHtml(g.comment_count ?? 0)}</span>`);

      const tags = (g.tags || []).slice(0, 3).map(t => `<span class="badge">${escapeHtml(t)}</span>`).join(" ");

      const preview = twoLinePreview(g.details || "");

      el.innerHTML = `
        <h4>${escapeHtml(g.title)}</h4>
        <div class="meta">
          ${metaBadges.join(" ")}
          <span class="badge">Por: ${escapeHtml(g.author_display_name || "Usu√°rio")} (@${escapeHtml(g.author_username || "?")})</span>
        </div>
        <div class="preview">${withMentions(preview)}</div>
        <div class="meta" style="margin-top:8px;">
          ${tags}
        </div>
        <div class="btnRow">
          <button class="secondary" data-open="1">Abrir</button>
        </div>
      `;

      el.querySelector('[data-open="1"]').onclick = async () => {
        selected = g;
        await openDetail(g.id);
      };

      list.appendChild(el);
    }
  }

  async function computeKpis(cards){
    const total = cards.length;
    const conf = cards.filter(x => x.status==="CONFIRMADO").length;
    const apu  = cards.filter(x => x.status==="APURACAO").length;
    const arc  = cards.filter(x => x.status==="ARQUIVADO").length;
    $("k_total").textContent = total;
    $("k_confirm").textContent = conf;
    $("k_apu").textContent = apu;
    $("k_arch").textContent = arc;
  }

  async function openDetail(gossipId){
    try{
      setMsg("commentMsg","");
      showProfile(false);

      const { data, error } = await sb
        .from("gossip_cards")
        .select("*")
        .eq("id", gossipId)
        .single();
      if(error) throw error;
      selected = data;

      $("detailTitle").textContent = selected.title;
      $("detailBy").textContent = `Por: ${selected.author_display_name} (@${selected.author_username}) ‚Ä¢ Fonte: ${selected.source} ‚Ä¢ ${new Date(selected.created_at).toLocaleString()}`;
      $("detailText").innerHTML = withMentions(selected.details);

      $("detailMeta").innerHTML = `
        <span class="badge">${escapeHtml(selected.status)}</span>
        <span class="badge">Cred ${escapeHtml(selected.credibility)}</span>
        <span class="badge">üí¨ ${escapeHtml(selected.comment_count ?? 0)}</span>
      `;

      $("moveStatusSelect").value = selected.status || "APURACAO";

      const { data: { user } } = await sb.auth.getUser();
      const isMine = user?.id && selected.created_by === user.id;
      $("deleteBtn").style.display = isMine ? "inline-block" : "none";

      await renderReactions();
      await renderComments();

      showDetail(true);
      showDetailArea();
    }catch(e){
      selected = null;
      showDetail(false);
      setMsg("msg", e?.message || "Erro ao abrir.");
    }
  }

  $("closeDetailBtn").onclick = () => {
    selected = null;
    showDetail(false);
  };

  async function renderComments(){
    if(!selected) return;
    const box = $("comments");
    box.innerHTML = "";

    const res = await sb
      .from("comments")
      .select("id, body, created_at, user_id, profiles:profiles(username, display_name)")
      .eq("gossip_id", selected.id)
      .order("created_at", { ascending:true });

    if(res.error) throw res.error;

    const rows = res.data || [];
    if(rows.length === 0){
      const el = document.createElement("div");
      el.className = "muted";
      el.textContent = "Sem coment√°rios ainda‚Ä¶ seja o primeiro a opinar üëÄ";
      box.appendChild(el);
      return;
    }

    for(const c of rows){
      const it = document.createElement("div");
      it.className = "item";
      const who = c.profiles?.display_name ? `${c.profiles.display_name} (@${c.profiles.username})` : "Usu√°rio";
      it.innerHTML = `
        <div class="muted">${escapeHtml(who)} ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>
        <div style="margin-top:6px; white-space:pre-line;">${withMentions(c.body)}</div>
      `;
      box.appendChild(it);
    }
  }

  $("commentBtn").onclick = async () => {
    try{
      setMsg("commentMsg","");
      if(!selected) throw new Error("Nenhuma fofoca selecionada.");
      const body = ($("commentBody").value || "").trim();
      if(body.length < 2) throw new Error("Coment√°rio muito curto.");

      const { data: { user } } = await sb.auth.getUser();
      if(!user?.id) throw new Error("Voc√™ n√£o est√° logado.");

      const ins = await sb.from("comments").insert({
        gossip_id: selected.id,
        user_id: user.id,
        body
      });
      if(ins.error) throw ins.error;

      $("commentBody").value = "";
      setMsg("commentMsg", "Coment√°rio enviado.");

      await openDetail(selected.id);
      await refreshAll(false);
    }catch(e){
      setMsg("commentMsg", e?.message || "Erro ao comentar.");
    }
  };

  async function renderReactions(){
    if(!selected) return;
    const bar = $("detailReacts");
    bar.innerHTML = "";

    const agg = selected.reactions || {};

    const { data: { user } } = await sb.auth.getUser();
    const uid = user?.id;

    let mine = [];
    if(uid){
      const r = await sb
        .from("reactions")
        .select("reaction")
        .eq("gossip_id", selected.id)
        .eq("user_id", uid);
      if(!r.error) mine = (r.data || []).map(x => x.reaction);
    }

    for(const r of REACTIONS){
      const count = agg[r] || 0;
      const btn = document.createElement("button");
      btn.className = "reactBtn" + (mine.includes(r) ? " on" : "");
      btn.textContent = `${r} ${count}`;
      btn.onclick = async () => {
        await toggleReaction(r);
      };
      bar.appendChild(btn);
    }
  }

  async function toggleReaction(reaction){
    if(!selected) return;
    const { data: { user } } = await sb.auth.getUser();
    const uid = user?.id;
    if(!uid) return;

    const ex = await sb
      .from("reactions")
      .select("id")
      .eq("gossip_id", selected.id)
      .eq("user_id", uid)
      .eq("reaction", reaction)
      .maybeSingle();

    if(ex.data?.id){
      const del = await sb.from("reactions").delete().eq("id", ex.data.id);
      if(del.error) throw del.error;
    } else {
      const ins = await sb.from("reactions").insert({
        gossip_id: selected.id,
        user_id: uid,
        reaction
      });
      if(ins.error) throw ins.error;
    }

    await openDetail(selected.id);
    await refreshAll(false);
  }

  $("moveStatusBtn").onclick = async () => {
    try{
      if(!selected) throw new Error("Nenhuma fofoca selecionada.");
      const next = $("moveStatusSelect").value;

      const { data: { user } } = await sb.auth.getUser();
      const isMine = user?.id && selected.created_by === user.id;
      if(!isMine) throw new Error("Voc√™ s√≥ pode mover status das suas fofocas.");

      const upd = await sb
        .from("gossips")
        .update({ status: next })
        .eq("id", selected.id);

      if(upd.error) throw upd.error;

      await openDetail(selected.id);
      await refreshAll(false);
    }catch(e){
      setMsg("commentMsg", e?.message || "Erro ao mover status.");
    }
  };

  $("deleteBtn").onclick = async () => {
    try{
      if(!selected) return;

      const { data: { user } } = await sb.auth.getUser();
      const isMine = user?.id && selected.created_by === user.id;
      if(!isMine) throw new Error("Voc√™ s√≥ pode excluir suas fofocas.");

      if(!confirm("Tem certeza que deseja excluir este ticket?")) return;

      const del = await sb.from("gossips").delete().eq("id", selected.id);
      if(del.error) throw del.error;

      selected = null;
      showDetail(false);
      await refreshAll(true);
    }catch(e){
      setMsg("commentMsg", e?.message || "Erro ao excluir.");
    }
  };

  // ======= PROFILE TAB =======
  async function renderProfile(){
    showProfile(true);
    showDetail(false);

    const mineCount = await countMine();
    const title = titleFromCount(mineCount);

    $("profileBadges").innerHTML = `
      <span class="badge">üë§ ${escapeHtml(me.display_name)} (@${escapeHtml(me.username)})</span>
      <span class="badge">üè∑Ô∏è ${escapeHtml(title)}</span>
      <span class="badge">üó£Ô∏è Fofocas: ${escapeHtml(mineCount)}</span>
    `;

    $("profileStats").textContent = "Dica: o t√≠tulo muda automaticamente conforme voc√™ posta mais fofocas.";

    const res = await sb
      .from("gossip_cards")
      .select("*")
      .eq("created_by", me.id)
      .order("created_at", { ascending:false })
      .limit(50);

    if(res.error) throw res.error;

    const list = $("profileList");
    list.innerHTML = "";
    const rows = res.data || [];
    if(rows.length === 0){
      const el = document.createElement("div");
      el.className = "muted";
      el.textContent = "Voc√™ ainda n√£o postou nenhuma fofoca.";
      list.appendChild(el);
      return;
    }

    for(const g of rows){
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <h4>${escapeHtml(g.title)}</h4>
        <div class="meta">
          <span class="badge">${escapeHtml(g.status)}</span>
          <span class="badge">Cred ${escapeHtml(g.credibility)}</span>
          <span class="badge">üí¨ ${escapeHtml(g.comment_count ?? 0)}</span>
        </div>
        <div class="preview">${withMentions(twoLinePreview(g.details))}</div>
        <div class="btnRow">
          <button class="secondary">Abrir</button>
        </div>
      `;
      el.querySelector("button").onclick = async () => {
        mode = "mine";
        setActiveTab();
        selected = g;
        await refreshAll(false);
        await openDetail(g.id);
      };
      list.appendChild(el);
    }
  }

  // ======= REFRESH =======
  async function refreshAll(scrollTop){
    try{
      setActiveTab();
      showDetailArea();

      if(mode === "profile"){
        await renderProfile();
        return;
      }

      const cards = await fetchCards();
      await computeKpis(cards);
      renderList(cards);

      if(scrollTop) window.scrollTo({ top: 0, behavior: "smooth" });

      if(selected?.id){
        await openDetail(selected.id);
      }
    }catch(e){
      setMsg("msg", e?.message || "Erro ao carregar.");
    }
  }

  // ======= BOOT =======
  (async function boot(){
    const { data } = await sb.auth.getSession();
    session = data.session;

    if(session){
      try{
        await loadMe();
        setAuthUI(true);
        await refreshAll(false);
      }catch(err){
        await sb.auth.signOut();
        session = null;
        me = null;
        setAuthUI(false);
      }
    } else {
      setAuthUI(false);
    }

    sb.auth.onAuthStateChange(async (_event, _session) => {
      session = _session;
      if(session){
        await loadMe();
        setAuthUI(true);
        await refreshAll(false);
      } else {
        me = null;
        selected = null;
        setAuthUI(false);
      }
    });
  })();
</script>
</body>
</html>
