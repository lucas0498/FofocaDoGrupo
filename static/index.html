<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>GossipCRM â€” Enterprise Fofoca Management</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0f14; color: #e6edf3; }
    header { padding: 18px 22px; border-bottom: 1px solid #1f2a37; display:flex; gap:12px; align-items:center; }
    .brand { font-weight: 800; letter-spacing: 0.5px; }
    .tagline { opacity: .75; font-size: 12px; }

    main { display: grid; grid-template-columns: 420px 1fr; gap: 16px; padding: 16px; align-items:start; }
    .card { background: #0f1620; border: 1px solid #1f2a37; border-radius: 14px; padding: 14px; }
    .cardTitle { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    input, textarea, select, button {
      width: 100%; box-sizing: border-box; padding: 10px 10px; border-radius: 10px;
      border: 1px solid #243244; background: #0b111a; color: #e6edf3; outline: none;
    }
    textarea { min-height: 90px; resize: vertical; }
    button { cursor: pointer; background: #1b3a57; border-color: #2b4a66; font-weight: 700; }
    button:hover { filter: brightness(1.08); }
    button:disabled { opacity: .45; cursor:not-allowed; filter:none; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { opacity: .75; font-size: 12px; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; border: 1px solid #2a3a52; font-size: 12px; opacity:.9; }
    .danger { background:#4a1d1d; border-color:#6a2b2b; }
    .good { background:#153a2a; border-color:#1f5b40; }
    .ghost { background: transparent; border-color: #2a3a52; }

    .kpis { display:flex; gap:10px; flex-wrap:wrap; }
    .kpi { background:#0b111a; border:1px solid #203044; border-radius: 14px; padding: 10px 12px; min-width: 120px; }
    .kpi .v { font-size: 18px; font-weight: 800; }
    .kpi .l { font-size: 12px; opacity:.75; }

    .list { display:flex; flex-direction: column; gap: 10px; }
    .item { border: 1px solid #203044; background:#0b111a; border-radius: 14px; padding: 12px; }
    .item:hover { border-color:#2d425c; }
    .item h3 { margin: 0 0 6px 0; font-size: 16px; }
    .meta { display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 8px; }
    .clickable { cursor:pointer; }

    .split { display:grid; grid-template-columns: 1fr; gap:16px; }
    .detailsBox { white-space:pre-wrap; line-height:1.4; }
    .commentBox { display:flex; gap:10px; align-items:flex-start; }
    .commentBox textarea { min-height: 60px; }
    .comment { border:1px solid #203044; border-radius: 14px; background:#0b111a; padding: 10px; }
    .comment .who { font-weight:700; }
    .comment .when { opacity:.7; font-size:12px; margin-left:6px; }
    .comment .body { white-space:pre-wrap; margin-top:6px; }

    @media (max-width: 980px){ main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
<header>
  <div>
    <div class="brand">GossipCRM</div>
    <div class="tagline">Enterprise Fofoca Management â€¢ Observability â€¢ Compliance â€¢ GovernanÃ§a de Tias</div>
  </div>
  <div style="margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
    <span id="who" class="muted"></span>
    <button id="logoutBtn" style="width:auto; display:none;">Sair</button>
  </div>
</header>

<main>
  <!-- AUTH -->
  <section class="card" id="authCard">
    <h2 id="authTitle" style="margin-top:0;">Acesso</h2>
    <div id="authHint" class="muted">
      Entre com sua conta. Se ainda nÃ£o tiver, clique em <b>Criar conta</b>.
    </div>

    <div style="margin-top:10px; display:none;" id="nameField">
      <input id="n" placeholder="Nome (ex: Dona Cida do 302)"/>
    </div>

    <div style="margin-top:10px;">
      <input id="u" placeholder="UsuÃ¡rio (ex: lucas_fofoca)" />
    </div>

    <div style="margin-top:10px;">
      <input id="p" placeholder="Senha" type="password" />
    </div>

    <div class="row" id="authButtons" style="margin-top:10px;">
      <button id="loginBtn">Entrar</button>
      <button id="goRegisterBtn" class="good">Criar conta</button>
    </div>

    <div id="registerButtons" style="display:none; margin-top:10px;">
      <button id="registerBtn" class="good">Confirmar cadastro</button>
      <div style="height:10px;"></div>
      <button id="backToLoginBtn" class="ghost">Voltar para o login</button>
    </div>

    <div id="authMsg" class="muted" style="margin-top:10px;"></div>
  </section>

  <!-- APP -->
  <section class="split" id="appCard" style="display:none;">
    <!-- LEFT: Sidebar -->
    <section class="card">
      <div class="cardTitle">
        <h2 style="margin:0;">Dashboard</h2>
        <button id="refreshBtn" style="width:auto;">Atualizar</button>
      </div>

      <div style="height:10px;"></div>
      <div class="kpis" id="kpis"></div>

      <div style="height:10px;"></div>
      <div id="profile" class="muted"></div>

      <div style="height:16px;"></div>
      <h3 style="margin:0 0 10px 0;">Filtros</h3>
      <input id="q" placeholder="Pesquisar..." />
      <div style="height:10px;"></div>
      <select id="statusFilter">
        <option value="">Todas</option>
        <option value="LEAD">LEAD</option>
        <option value="APURACAO">APURAÃ‡ÃƒO</option>
        <option value="CONFIRMADO">CONFIRMADO</option>
        <option value="ARQUIVADO">ARQUIVADO</option>
      </select>

      <div style="height:18px;"></div>
      <h3 style="margin:0 0 10px 0;">Nova ocorrÃªncia</h3>

      <div class="row">
        <div>
          <label class="muted">TÃ­tulo</label>
          <input id="title" placeholder="Ex: Fulano foi visto..." />
        </div>
        <div>
          <label class="muted">Fonte</label>
          <input id="source" placeholder="Ex: zelador, grupo da famÃ­lia" />
        </div>
      </div>

      <div style="height:10px;"></div>
      <label class="muted">Detalhes</label>
      <textarea id="details" placeholder="Descreva com seriedade corporativa..."></textarea>

      <div style="height:10px;"></div>
      <div class="row">
        <div>
          <label class="muted">Status</label>
          <select id="status">
            <option value="LEAD">LEAD</option>
            <option value="APURACAO">APURAÃ‡ÃƒO</option>
            <option value="CONFIRMADO">CONFIRMADO</option>
            <option value="ARQUIVADO">ARQUIVADO</option>
          </select>
        </div>
        <div>
          <label class="muted">Confiabilidade (0â€“100)</label>
          <input id="cred" type="number" min="0" max="100" value="50"/>
        </div>
      </div>

      <div style="height:10px;"></div>
      <label class="muted">Tags (separadas por vÃ­rgula)</label>
      <input id="tags" placeholder="ouvi falar, fonte confiÃ¡vel, primo do amigo" />

      <div style="height:12px;"></div>
      <button id="createBtn">Registrar ticket</button>
      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </section>

    <!-- RIGHT: Backlog + Viewer -->
    <section class="card">
      <div class="cardTitle">
        <h2 style="margin:0;">Backlog</h2>
        <span class="muted">Clique em um item para abrir</span>
      </div>

      <div style="height:10px;"></div>
      <div class="list" id="list"></div>

      <div style="height:16px;"></div>
      <h2 style="margin:0;">VisualizaÃ§Ã£o</h2>
      <div id="viewerEmpty" class="muted" style="margin-top:8px;">
        Selecione uma fofoca no backlog para ver detalhes e comentar.
      </div>

      <div id="viewer" style="display:none; margin-top:10px;">
        <div class="meta" id="vMeta"></div>
        <h3 id="vTitle" style="margin: 0 0 8px 0;"></h3>
        <div id="vDetails" class="detailsBox"></div>

        <div style="height:12px;"></div>
        <div class="meta" id="vTags"></div>

        <div style="height:12px;"></div>
        <div class="row">
          <button id="moveBtn">Mover status</button>
          <button id="deleteBtn" class="danger">Excluir</button>
        </div>

        <div style="height:18px;"></div>
        <div class="cardTitle">
          <h3 style="margin:0;">ComentÃ¡rios</h3>
          <span id="cCount" class="muted"></span>
        </div>

        <div style="height:10px;"></div>
        <div class="commentBox">
          <textarea id="cBody" placeholder="Escreva um comentÃ¡rio..."></textarea>
          <button id="cSend" style="width:auto;">Enviar</button>
        </div>
        <div id="cMsg" class="muted" style="margin-top:8px;"></div>

        <div style="height:10px;"></div>
        <div class="list" id="comments"></div>

        <div style="height:16px;"></div>
        <h3 style="margin:0 0 10px 0;">Audit Log</h3>
        <div class="list" id="audit"></div>

        <div style="height:16px;"></div>
        <h3 style="margin:0 0 10px 0;">Leaderboard</h3>
        <div class="list" id="leaderboard"></div>
      </div>
    </section>
  </section>
</main>

<script>
let TOKEN = null;
let USERNAME = null;
let MODE = "login"; // login | register
let SELECTED_ID = null;
let SELECTED_GOSSIP = null;

function authHeader(){ return TOKEN ? { "Authorization": "Bearer " + TOKEN } : {}; }

async function api(path, opts={}){
  const res = await fetch(path, {
    ...opts,
    headers: { "Content-Type":"application/json", ...(opts.headers||{}), ...authHeader() }
  });
  const text = await res.text();
  let data = null;
  try { data = text ? JSON.parse(text) : null; } catch { data = text; }

  if(!res.ok){
    let msg = "Erro " + res.status;
    if (data && data.detail) {
      if (Array.isArray(data.detail)) {
        msg = data.detail.map(e => `${(e.loc||[]).slice(-1)[0]||"campo"}: ${e.msg}`).join(" | ");
      } else msg = data.detail;
    }
    throw new Error(msg);
  }
  return data;
}

function setAuthUI(logged){
  document.getElementById("authCard").style.display = logged ? "none" : "block";
  document.getElementById("appCard").style.display = logged ? "grid" : "none";
  document.getElementById("logoutBtn").style.display = logged ? "inline-block" : "none";
  document.getElementById("who").textContent = logged ? ("Logado como: " + USERNAME) : "";
}

function setMode(mode){
  MODE = mode;
  const isReg = MODE === "register";
  document.getElementById("authTitle").textContent = isReg ? "Criar conta" : "Acesso";
  document.getElementById("authHint").innerHTML = isReg
    ? "Preencha os dados para cadastrar. Depois vocÃª faz login normalmente."
    : "Entre com sua conta. Se ainda nÃ£o tiver, clique em <b>Criar conta</b>.";
  document.getElementById("nameField").style.display = isReg ? "block" : "none";
  document.getElementById("registerButtons").style.display = isReg ? "block" : "none";
  document.getElementById("authButtons").style.display = isReg ? "none" : "grid";
  document.getElementById("authMsg").textContent = "";
}

function fmtTs(ts){ return new Date(ts * 1000).toLocaleString(); }

function renderKpis(d){
  const k = document.getElementById("kpis");
  k.innerHTML = "";
  const mk = (v, l) => `<div class="kpi"><div class="v">${v}</div><div class="l">${l}</div></div>`;
  k.insertAdjacentHTML("beforeend", mk(d.total, "Tickets totais"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.LEAD, "LEAD"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.APURACAO, "APURAÃ‡ÃƒO"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.CONFIRMADO, "CONFIRMADO"));
  k.insertAdjacentHTML("beforeend", mk(d.by_status.ARQUIVADO, "ARQUIVADO"));
  k.insertAdjacentHTML("beforeend", mk(d.avg_credibility.toFixed(1), "Credibilidade mÃ©dia"));
}

function backlogItem(g){
  const tags = (g.tags||[]).slice(0,3).map(t=>`<span class="pill">${t}</span>`).join(" ");
  const active = (SELECTED_ID === g.id) ? "style='border-color:#3a5677;'" : "";
  return `
  <div class="item clickable" ${active} onclick="openGossip(${g.id})">
    <h3>${g.title}</h3>
    <div class="meta">
      <span class="pill">${g.status}</span>
      <span class="pill">Cred ${g.credibility}</span>
      <span class="pill">Por: ${g.created_by}</span>
      <span class="pill">ðŸ’¬ ${g.comment_count}</span>
    </div>
    <div class="muted">${g.source} â€¢ ${fmtTs(g.updated_at)}</div>
    <div style="margin-top:8px;">${tags}</div>
  </div>`;
}

async function refresh(){
  const q = document.getElementById("q").value.trim();
  const st = document.getElementById("statusFilter").value;

  const dash = await api("/api/dashboard");
  renderKpis(dash);

  const me = await api("/api/me");
  USERNAME = me.label;
  document.getElementById("who").textContent = `Logado como: ${me.label} â€¢ TÃ­tulo: ${me.title} â€¢ Fofocas: ${me.total_gossips}`;

  const medals = (me.badges||[]).map(b => `<span class="pill">${b}</span>`).join(" ");
  document.getElementById("profile").innerHTML = medals
    ? `Conquistas: ${medals}`
    : `<span class="muted">Conquistas: nenhuma aindaâ€¦ poste mais babados ðŸ˜„</span>`;

  const url = new URL(location.origin + "/api/gossips");
  if(q) url.searchParams.set("q", q);
  if(st) url.searchParams.set("status_filter", st);
  const gossips = await api(url.pathname + url.search);

  document.getElementById("list").innerHTML = gossips.map(backlogItem).join("");

  // mantÃ©m seleÃ§Ã£o se existir
  if (SELECTED_ID) {
    const still = gossips.find(x => x.id === SELECTED_ID);
    if (still) await openGossip(SELECTED_ID, true);
    else clearViewer();
  }
}

function clearViewer(){
  SELECTED_ID = null;
  SELECTED_GOSSIP = null;
  document.getElementById("viewerEmpty").style.display = "block";
  document.getElementById("viewer").style.display = "none";
}

async function openGossip(id, silent=false){
  SELECTED_ID = id;
  SELECTED_GOSSIP = await api("/api/gossips/" + id);

  document.getElementById("viewerEmpty").style.display = "none";
  document.getElementById("viewer").style.display = "block";

  document.getElementById("vTitle").textContent = SELECTED_GOSSIP.title;
  document.getElementById("vDetails").textContent = SELECTED_GOSSIP.details;

  document.getElementById("vMeta").innerHTML = `
    <span class="pill">Status: ${SELECTED_GOSSIP.status}</span>
    <span class="pill">Cred: ${SELECTED_GOSSIP.credibility}</span>
    <span class="pill">Fonte: ${SELECTED_GOSSIP.source}</span>
    <span class="pill">Por: ${SELECTED_GOSSIP.created_by}</span>
    <span class="pill">Criado: ${fmtTs(SELECTED_GOSSIP.created_at)}</span>
    <span class="pill">Atualizado: ${fmtTs(SELECTED_GOSSIP.updated_at)}</span>
  `;

  const tags = (SELECTED_GOSSIP.tags||[]).map(t=>`<span class="pill">${t}</span>`).join(" ");
  document.getElementById("vTags").innerHTML = tags || `<span class="muted">Sem tags</span>`;

  document.getElementById("cBody").value = "";
  document.getElementById("cMsg").textContent = "";

  await loadComments();
  await loadAuditAndLeaderboard();

  if (!silent) await refresh(); // repinta backlog com item selecionado
}

async function loadComments(){
  if(!SELECTED_ID) return;
  const comments = await api(`/api/gossips/${SELECTED_ID}/comments`);
  document.getElementById("cCount").textContent = `${comments.length} comentÃ¡rio(s)`;
  document.getElementById("comments").innerHTML = comments.map(c => `
    <div class="comment">
      <div><span class="who">${c.author}</span><span class="when">${fmtTs(c.created_at)}</span></div>
      <div class="body">${escapeHtml(c.body)}</div>
    </div>
  `).join("") || `<div class="muted">Nenhum comentÃ¡rio aindaâ€¦ seja o primeiro ðŸ˜„</div>`;
}

async function loadAuditAndLeaderboard(){
  const audit = await api("/api/audit?limit=12");
  document.getElementById("audit").innerHTML = audit.map(x => `
    <div class="item">
      <div class="meta">
        <span class="pill">${fmtTs(x.ts)}</span>
        <span class="pill">${x.user}</span>
        <span class="pill">${x.action}</span>
        <span class="pill">${x.entity}#${x.entity_id ?? "-"}</span>
      </div>
      <div class="muted">${x.meta}</div>
    </div>
  `).join("");

  const lb = await api("/api/leaderboard?limit=10");
  document.getElementById("leaderboard").innerHTML = lb.map((x, i) => `
    <div class="item">
      <div class="meta">
        <span class="pill">#${i+1}</span>
        <span class="pill">${x.label}</span>
        <span class="pill">${x.total} fofocas</span>
      </div>
    </div>
  `).join("");
}

function escapeHtml(str){
  return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

async function create(){
  const payload = {
    title: document.getElementById("title").value.trim(),
    source: document.getElementById("source").value.trim() || "anÃ´nimo corporativo",
    details: document.getElementById("details").value.trim(),
    credibility: Number(document.getElementById("cred").value || 0),
    status: document.getElementById("status").value,
    tags: (document.getElementById("tags").value || "")
      .split(",").map(s => s.trim()).filter(Boolean),
  };

  if(payload.title.length < 3 || payload.details.length < 3){
    document.getElementById("msg").textContent = "Preenche tÃ­tulo e detalhes, Compliance agradece.";
    return;
  }

  const created = await api("/api/gossips", { method:"POST", body: JSON.stringify(payload) });
  document.getElementById("msg").textContent = "Ticket registrado com excelÃªncia operacional.";

  document.getElementById("title").value = "";
  document.getElementById("details").value = "";
  document.getElementById("tags").value = "";

  await refresh();
  await openGossip(created.id);
}

async function delSelected(){
  if(!SELECTED_ID) return;
  if(!confirm("Excluir esse ticket?")) return;
  await api("/api/gossips/" + SELECTED_ID, { method:"DELETE" });
  clearViewer();
  await refresh();
}

async function moveSelected(){
  if(!SELECTED_GOSSIP) return;
  const order = ["LEAD","APURACAO","CONFIRMADO","ARQUIVADO"];
  const i = order.indexOf(SELECTED_GOSSIP.status);
  const next = order[(i+1)%order.length];

  const payload = { ...SELECTED_GOSSIP, status: next };
  await api("/api/gossips/" + SELECTED_ID, { method:"PATCH", body: JSON.stringify(payload) });
  await openGossip(SELECTED_ID, true);
  await refresh();
}

async function sendComment(){
  if(!SELECTED_ID) return;
  const body = document.getElementById("cBody").value.trim();
  if(body.length < 1){
    document.getElementById("cMsg").textContent = "Escreva algo antes de enviar.";
    return;
  }
  await api(`/api/gossips/${SELECTED_ID}/comments`, { method:"POST", body: JSON.stringify({body}) });
  document.getElementById("cBody").value = "";
  document.getElementById("cMsg").textContent = "ComentÃ¡rio enviado âœ…";
  await openGossip(SELECTED_ID, true);
  await refresh();
}

// ===== Auth =====
document.getElementById("goRegisterBtn").onclick = () => setMode("register");
document.getElementById("backToLoginBtn").onclick = () => setMode("login");

document.getElementById("registerBtn").onclick = async () => {
  try{
    const name = document.getElementById("n").value.trim();
    const username = document.getElementById("u").value.trim();
    const password = document.getElementById("p").value;

    if(name.length < 2) return (document.getElementById("authMsg").textContent = "Nome mÃ­nimo 2 caracteres.");
    if(username.length < 3) return (document.getElementById("authMsg").textContent = "UsuÃ¡rio mÃ­nimo 3 caracteres.");
    if(password.length < 4) return (document.getElementById("authMsg").textContent = "Senha mÃ­nima 4 caracteres.");

    await api("/api/register", { method:"POST", body: JSON.stringify({name, username, password}) });
    document.getElementById("authMsg").textContent = `Conta criada, ${name}! Volte e faÃ§a login.`;
  }catch(e){
    document.getElementById("authMsg").textContent = e.message;
  }
};

document.getElementById("loginBtn").onclick = async () => {
  try{
    const username = document.getElementById("u").value.trim();
    const password = document.getElementById("p").value;

    if(!username || !password) return (document.getElementById("authMsg").textContent = "Preencha usuÃ¡rio e senha.");

    const out = await api("/api/login", { method:"POST", body: JSON.stringify({username, password}) });
    TOKEN = out.token;
    USERNAME = out.display_name ? `${out.display_name} (@${out.username})` : out.username;

    setAuthUI(true);
    await refresh();
    clearViewer();
  }catch(e){
    document.getElementById("authMsg").textContent = e.message;
  }
};

document.getElementById("logoutBtn").onclick = async () => {
  try{ await api("/api/logout", { method:"POST" }); }catch(e){}
  TOKEN = null; USERNAME = null;
  setAuthUI(false);
  setMode("login");
  clearViewer();
};

document.getElementById("createBtn").onclick = create;
document.getElementById("refreshBtn").onclick = refresh;
document.getElementById("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") refresh(); });
document.getElementById("statusFilter").addEventListener("change", refresh);

document.getElementById("deleteBtn").onclick = delSelected;
document.getElementById("moveBtn").onclick = moveSelected;
document.getElementById("cSend").onclick = sendComment;

setMode("login");
clearViewer();
</script>
</body>
</html>
