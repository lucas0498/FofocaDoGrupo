<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FofocaDoGrupo â€¢ GossipCRM</title>
  <style>
    :root{
      --bg:#070b10;
      --panel:#0b1220;
      --panel2:#0a111e;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --accent:#2b74ff;
      --green:#1faa63;
      --danger:#d84b4b;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1000px 500px at 20% 0%, rgba(43,116,255,.14), transparent 60%),
                  radial-gradient(1000px 500px at 80% 0%, rgba(31,170,99,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      min-height:100vh;
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: rgba(7,11,16,.72);
      border-bottom:1px solid var(--stroke);
    }
    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:18px 16px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .brand small{
      display:block;
      color:var(--muted);
      margin-top:4px;
      font-size:12px;
    }
    .rightbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn.primary{
      background: rgba(43,116,255,.22);
      border-color: rgba(43,116,255,.35);
    }
    .btn.good{
      background: rgba(31,170,99,.22);
      border-color: rgba(31,170,99,.35);
    }
    .btn.danger{
      background: rgba(216,75,75,.18);
      border-color: rgba(216,75,75,.35);
    }
    .btn:disabled{
      opacity:.5; cursor:not-allowed;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr 420px;
      gap:16px;
      align-items:start;
      padding:18px 16px 36px;
      max-width:1280px;
      margin:0 auto;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--stroke);
      display:flex; justify-content:space-between; align-items:flex-end; gap:10px;
    }
    .card .hd h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .card .hd .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:4px;
    }
    .card .bd{ padding:14px; }
    .muted{ color:var(--muted); }
    .msg{ margin-top:10px; color:var(--muted); font-size:13px; min-height:18px;}
    .err{ color:#ffb4b4; }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .kpi{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.14);
    }
    .kpi .v{ font-size:18px; font-weight:800; }
    .kpi .l{ color:var(--muted); font-size:11px; margin-top:2px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:120px; }
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:120px; resize:vertical; }
    label{ font-size:12px; color:var(--muted); display:block; margin:10px 0 6px; }

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px 14px;
      border-bottom:1px solid var(--stroke);
      background: rgba(0,0,0,.12);
    }
    .tab{ border-radius:999px; padding:8px 10px; border:1px solid var(--stroke); background: rgba(255,255,255,.03); color:var(--text); cursor:pointer; font-weight:700; font-size:12px;}
    .tab.active{ background: rgba(31,170,99,.20); border-color: rgba(31,170,99,.35); }
    .tab.secondary.active{ background: rgba(43,116,255,.20); border-color: rgba(43,116,255,.35); }
    .tab.ghost{ background: rgba(255,255,255,.02); color:var(--muted); font-weight:600;}

    /* Feed cards */
    .feed{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 1100px){
      .feed{ grid-template-columns: 1fr; }
    }
    .ticket{
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.12);
    }
    .ticket h3{
      margin:0 0 6px;
      font-size:15px;
      line-height:1.2;
    }
    .meta{
      display:flex; flex-wrap:wrap; gap:8px;
      color:var(--muted);
      font-size:12px;
      margin-bottom:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
    }
    .tag{
      display:inline-flex;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      color:var(--muted);
      font-size:12px;
    }
    .preview{
      color:rgba(255,255,255,.82);
      font-size:13px;
      line-height:1.35;
      margin:10px 0;
      white-space:pre-wrap;
    }
    .ticket .actions{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-top:8px;
    }
    .reactions{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .react{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      font-size:12px;
      color:var(--muted);
    }
    .react:hover{ background: rgba(255,255,255,.04); }
    .openbtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(43,116,255,.35);
      background: rgba(43,116,255,.18);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .openbtn:hover{ background: rgba(43,116,255,.24); }

    /* Detail/comments */
    .detail h3{ margin:0 0 6px; }
    .detail .big{ white-space:pre-wrap; color:rgba(255,255,255,.86); font-size:13px; line-height:1.35; }
    .divider{ border-top:1px solid var(--stroke); margin:12px 0; }
    .comment{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px;
      background: rgba(0,0,0,.10);
      margin-bottom:10px;
    }
    .comment .who{ color:var(--muted); font-size:12px; margin-bottom:6px; display:flex; justify-content:space-between; gap:10px;}
    .comment .body{ white-space:pre-wrap; font-size:13px; color:rgba(255,255,255,.84); }

    /* Auth card */
    .authgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div>
          <h1>FofocaDoGrupo</h1>
          <small>Fofoca Management â€¢ Observability â€¢ Compliance â€¢ GovernanÃ§a de Tias</small>
        </div>
        <div class="rightbar">
          <span class="pill" id="sessionPill">NÃ£o logado</span>
          <button class="btn danger" id="logoutBtn" style="display:none">Sair</button>
        </div>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card" id="leftCard">
      <div class="hd">
        <div>
          <h2>Dashboard</h2>
          <div class="sub" id="titleLine">TÃ­tulo: â€” â€¢ Fofoqueiro(a): â€”</div>
        </div>
        <button class="btn primary" id="refreshBtn">Atualizar</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabFeed">Feed (grupo)</button>
        <button class="tab" id="tabMine">Meu Backlog</button>
        <button class="tab ghost" id="tabProfile">Perfil</button>
      </div>

      <div class="bd">
        <div class="kpis" id="kpis"></div>

        <div class="divider"></div>

        <h3 style="margin:0 0 8px;">Nova ocorrÃªncia</h3>

        <label>TÃ­tulo</label>
        <input id="title" placeholder="Ex: Fulano foi visto com..."/>

        <div class="row">
          <div>
            <label>Fonte</label>
            <input id="source" placeholder="Ex: zelador, grupo da famÃ­lia"/>
          </div>
          <div>
            <label>Status</label>
            <select id="status">
              <option value="APURACAO">APURAÃ‡ÃƒO</option>
              <option value="CONFIRMADO">CONFIRMADO</option>
              <option value="ARQUIVADO">ARQUIVADO</option>
            </select>
          </div>
        </div>

        <label>Detalhes</label>
        <textarea id="details" placeholder="Descreva com seriedade corporativa... (use @usuario para mencionar)"></textarea>

        <div class="row">
          <div>
            <label>Confiabilidade (0â€“100)</label>
            <input id="cred" type="number" min="0" max="100" value="50"/>
          </div>
          <div>
            <label>Tags (vÃ­rgula)</label>
            <input id="tags" placeholder="fonte confiÃ¡vel, ouvi falar, primo do amigo"/>
          </div>
        </div>

        <div style="margin-top:12px;" class="row">
          <button class="btn good" id="createBtn">Registrar ticket</button>
        </div>

        <div class="msg" id="msg"></div>

        <div class="divider"></div>

        <div id="authCard">
          <h3 style="margin:0 0 8px;">Acesso</h3>
          <div class="muted" style="font-size:13px;margin-bottom:10px;">
            Crie sua conta e vire uma entidade do bairro. (Login sem email real)
          </div>
          <div class="authgrid">
            <input id="u" placeholder="UsuÃ¡rio (ex: lucas_fofoca)"/>
            <input id="name" placeholder="Nome (ex: Lucas)"/>
            <input id="p" type="password" placeholder="Senha (min 6)"/>
          </div>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="loginBtn">Entrar</button>
            <button class="btn good" id="registerBtn">Criar conta</button>
          </div>
          <div class="msg err" id="authMsg"></div>
        </div>
      </div>
    </div>

    <!-- CENTER -->
    <div class="card">
      <div class="hd">
        <div>
          <h2>Explorar</h2>
          <div class="sub" id="feedHint">Feed do grupo (todas as fofocas)</div>
        </div>
        <div class="row" style="margin:0; gap:10px;">
          <input id="q" placeholder="Pesquisar..." style="min-width:220px"/>
        </div>
      </div>
      <div class="bd">
        <div class="feed" id="feed"></div>
        <div class="muted" id="emptyFeed" style="display:none; padding:10px 0;">
          Nada por aqui ainda. Seja o primeiro a movimentar o compliance ðŸ‘€
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="hd">
        <div>
          <h2>VisualizaÃ§Ã£o</h2>
          <div class="sub">Detalhes + colaboraÃ§Ã£o</div>
        </div>
      </div>
      <div class="bd">
        <div class="muted" id="detailEmpty">Selecione uma fofoca no feed/backlog para ver detalhes e colaborar.</div>
        <div id="detail" style="display:none;" class="detail">
          <h3 id="dTitle"></h3>
          <div class="meta" id="dMeta"></div>
          <div class="big" id="dBody"></div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn" id="moveBtn">Mover status</button>
            <button class="btn danger" id="delBtn">Excluir (sÃ³ dono)</button>
          </div>

          <div class="divider"></div>

          <h3 style="margin:0 0 10px;">ComentÃ¡rios</h3>
          <div id="comments"></div>

          <label>Adicionar comentÃ¡rio</label>
          <textarea id="cBody" placeholder="Ex: isso procede? @fulano confirma?"></textarea>
          <div class="row" style="margin-top:10px;">
            <button class="btn primary" id="commentBtn">Comentar</button>
          </div>
          <div class="msg" id="cMsg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG (troque pelos seus) ======
    const SUPABASE_URL = "https://vguiwuiwgiuhtoifgjin.supabase.co";
    const SUPABASE_ANON_KEY = "COLE_SUA_ANON_KEY_AQUI";
    // ======================================

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // state
    let SESSION = null;
    let ME = null;
    let MODE = "feed"; // feed | mine | profile
    let SELECTED = null; // selected gossip row

    const REACTIONS = [
      {key:"like", label:"ðŸ‘"},
      {key:"lol", label:"ðŸ˜‚"},
      {key:"shock", label:"ðŸ˜±"},
      {key:"tea", label:"ðŸµ"},
      {key:"fire", label:"ðŸ”¥"},
    ];

    // helpers
    const $ = (id)=>document.getElementById(id);
    const cleanUser = (u)=> (u||"").trim().toLowerCase().replace(/\s+/g,"");
    const usernameToEmail = (u)=> cleanUser(u) + "@fofoca.fake";

    function setMsg(el, txt, isErr=false){
      el.textContent = txt || "";
      el.classList.toggle("err", !!isErr);
    }

    function shortPreview(details){
      const s = (details||"").trim();
      const lines = s.split("\n").slice(0,2).join("\n");
      return (lines.length < s.length) ? (lines + "â€¦") : lines;
    }

    function titleFromCount(n){
      if(n >= 50) return "VovÃ³zinha do bairro ðŸ§¶";
      if(n >= 25) return "Tia do Zap Premium ðŸ“²";
      if(n >= 10) return "Fofoqueiro(a) SÃªnior â˜•";
      if(n >= 3)  return "Fofoqueiro(a) em treinamento ðŸ‘€";
      return "Aprendiz de Fofoqueiro(a) ðŸŒ±";
    }

    function badgesFromCount(n){
      const b = [];
      if(n >= 1) b.push("Primeira fofoca âœ…");
      if(n >= 3) b.push("Dedinho coÃ§ando ðŸ‘†");
      if(n >= 10) b.push("Radar ligado ðŸ“¡");
      if(n >= 25) b.push("Zap dos bastidores ðŸ“²");
      if(n >= 50) b.push("MemÃ³ria coletiva ðŸ§ ");
      return b;
    }

    async function loadSession(){
      const { data } = await sb.auth.getSession();
      SESSION = data.session || null;
      if(SESSION){
        $("logoutBtn").style.display = "inline-block";
        $("authCard").style.display = "none";
        $("sessionPill").textContent = "Logado";
      }else{
        $("logoutBtn").style.display = "none";
        $("authCard").style.display = "block";
        $("sessionPill").textContent = "NÃ£o logado";
      }
    }

    async function ensureProfile(username, displayName){
      const uid = SESSION.user.id;

      const { data: existing, error: e1 } = await sb
        .from("profiles")
        .select("*")
        .eq("id", uid)
        .maybeSingle();

      if(e1) throw e1;

      if(existing) return existing;

      const payload = {
        id: uid,
        username: cleanUser(username),
        display_name: (displayName||username||"UsuÃ¡rio").trim()
      };

      const { data: inserted, error: e2 } = await sb
        .from("profiles")
        .insert(payload)
        .select("*")
        .single();

      if(e2) throw e2;
      return inserted;
    }

    async function loadMe(){
      if(!SESSION) { ME = null; $("titleLine").textContent = "TÃ­tulo: â€” â€¢ Fofoqueiro(a): â€”"; return; }

      const uid = SESSION.user.id;

      const { data: prof, error: e1 } = await sb
        .from("profiles").select("*")
        .eq("id", uid).single();

      if(e1) throw e1;

      const { count, error: e2 } = await sb
        .from("gossips")
        .select("*", { count: "exact", head: true })
        .eq("created_by", uid);

      if(e2) throw e2;

      const total = count || 0;
      ME = {
        ...prof,
        total_gossips: total,
        title: titleFromCount(total),
        badges: badgesFromCount(total)
      };

      $("titleLine").textContent = `TÃ­tulo: ${ME.title} â€¢ Fofoqueiro(a): ${ME.display_name} (@${ME.username})`;
      $("msg").innerHTML = `Suas conquistas: ${
        ME.badges.length ? ME.badges.map(x=>`<span class="tag">${x}</span>`).join(" ") : "<span class='muted'>Nenhuma aindaâ€¦</span>"
      }`;
    }

    async function loadKpis(){
      if(!SESSION){
        $("kpis").innerHTML = `
          <div class="kpi"><div class="v">â€”</div><div class="l">Tickets totais</div></div>
          <div class="kpi"><div class="v">â€”</div><div class="l">CONFIRMADO</div></div>
          <div class="kpi"><div class="v">â€”</div><div class="l">APURAÃ‡ÃƒO</div></div>
          <div class="kpi"><div class="v">â€”</div><div class="l">ARQUIVADO</div></div>
        `;
        return;
      }

      const base = (MODE === "mine") ? sb.from("gossips").select("status, credibility", { count: "exact" }).eq("created_by", SESSION.user.id)
                                     : sb.from("gossips").select("status, credibility", { count: "exact" });

      const { data, error, count } = await base;
      if(error) throw error;

      const by = { APURACAO:0, CONFIRMADO:0, ARQUIVADO:0 };
      let sum = 0;
      (data||[]).forEach(x=>{
        by[x.status] = (by[x.status]||0) + 1;
        sum += (x.credibility || 0);
      });
      const total = count || 0;
      const avg = total ? (sum/total) : 0;

      $("kpis").innerHTML = `
        <div class="kpi"><div class="v">${total}</div><div class="l">Tickets totais</div></div>
        <div class="kpi"><div class="v">${by.CONFIRMADO}</div><div class="l">CONFIRMADO</div></div>
        <div class="kpi"><div class="v">${by.APURACAO}</div><div class="l">APURAÃ‡ÃƒO</div></div>
        <div class="kpi"><div class="v">${avg.toFixed(1)}</div><div class="l">Credibilidade mÃ©dia</div></div>
      `;
    }

    function ticketHTML(g){
      const tags = (g.tags || []).slice(0,3).map(t=>`<span class="tag">${t}</span>`).join(" ");
      const preview = shortPreview(g.details);
      const who = g.author_display_name ? `${g.author_display_name} (@${g.author_username})` : (g.author_username ? `@${g.author_username}` : "â€”");
      const rs = g.reactions || {};
      const reactionPills = REACTIONS.map(r=>{
        const n = rs[r.key] || 0;
        return `<button class="react" onclick="reactTo('${g.id}','${r.key}')" title="Reagir">${r.label} ${n}</button>`;
      }).join("");

      return `
        <div class="ticket">
          <h3>${escapeHTML(g.title)}</h3>
          <div class="meta">
            <span class="badge">${g.status}</span>
            <span class="badge">Cred ${Number(g.credibility||0)}</span>
            <span class="badge">Por: ${escapeHTML(who)}</span>
          </div>
          <div class="preview">${escapeHTML(preview)}</div>
          <div class="meta">
            <span class="badge">Fonte: ${escapeHTML(g.source||"â€”")}</span>
            <span class="badge">ðŸ’¬ ${Number(g.comment_count||0)}</span>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">${tags}</div>
          <div class="actions">
            <div class="reactions">${reactionPills}</div>
            <button class="openbtn" onclick="openGossip('${g.id}')">Abrir</button>
          </div>
        </div>
      `;
    }

    function escapeHTML(s){
      return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    async function fetchFeed(){
      const q = $("q").value.trim();

      let query = sb.from("gossip_cards")
        .select("*")
        .order("created_at", { ascending:false })
        .limit(50);

      if(MODE === "mine" && SESSION){
        query = query.eq("created_by", SESSION.user.id);
      }

      if(q){
        // pesquisa simples por tÃ­tulo/detalhes
        // (ilike em duas colunas)
        query = query.or(`title.ilike.%${q}%,details.ilike.%${q}%`);
      }

      const { data, error } = await query;
      if(error) throw error;
      return data || [];
    }

    async function refreshAll(){
      try{
        setMsg($("authMsg"), "");
        setMsg($("msg"), "");
        setMsg($("cMsg"), "");

        await loadSession();

        if(!SESSION){
          $("feed").innerHTML = "";
          $("emptyFeed").style.display = "none";
          $("detail").style.display = "none";
          $("detailEmpty").style.display = "block";
          await loadKpis();
          return;
        }

        await loadMe();
        await loadKpis();

        const items = await fetchFeed();
        $("feed").innerHTML = items.map(ticketHTML).join("");
        $("emptyFeed").style.display = items.length ? "none" : "block";

        // se tinha selecionado algo, reabrir
        if(SELECTED){
          const found = items.find(x=>x.id === SELECTED.id);
          if(found) await openGossip(found.id);
        }

      }catch(e){
        console.error(e);
        setMsg($("msg"), (e && e.message) ? e.message : String(e), true);
      }
    }

    async function createTicket(){
      try{
        if(!SESSION){
          setMsg($("msg"), "VocÃª precisa estar logado para registrar ticket.", true);
          return;
        }

        const title = $("title").value.trim();
        const source = $("source").value.trim() || "anÃ´nimo corporativo";
        const details = $("details").value.trim();
        const credibility = Number($("cred").value || 0);
        const status = $("status").value;
        const tags = ($("tags").value || "").split(",").map(s=>s.trim()).filter(Boolean);

        if(title.length < 3 || details.length < 3){
          setMsg($("msg"), "Preenche tÃ­tulo e detalhes, Compliance agradece.", true);
          return;
        }

        const payload = {
          created_by: SESSION.user.id,
          title, source, details, credibility,
          status,
          tags
        };

        const { error } = await sb.from("gossips").insert(payload);
        if(error) throw error;

        $("title").value = "";
        $("source").value = "";
        $("details").value = "";
        $("tags").value = "";
        $("cred").value = "50";

        setMsg($("msg"), "Ticket registrado com excelÃªncia operacional.");
        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("msg"), e.message || String(e), true);
      }
    }

    async function openGossip(id){
      try{
        const { data, error } = await sb.from("gossip_cards").select("*").eq("id", id).single();
        if(error) throw error;
        SELECTED = data;

        $("detailEmpty").style.display = "none";
        $("detail").style.display = "block";

        $("dTitle").textContent = data.title;

        const who = data.author_display_name ? `${data.author_display_name} (@${data.author_username})` : (data.author_username ? `@${data.author_username}` : "â€”");
        $("dMeta").innerHTML = `
          <span class="badge">${data.status}</span>
          <span class="badge">Cred ${Number(data.credibility||0)}</span>
          <span class="badge">Por: ${escapeHTML(who)}</span>
          <span class="badge">Fonte: ${escapeHTML(data.source||"â€”")}</span>
        `;

        $("dBody").textContent = data.details || "";

        // permissÃ£o de excluir (sÃ³ dono)
        const canDel = SESSION && data.created_by === SESSION.user.id;
        $("delBtn").disabled = !canDel;

        await loadComments();
      }catch(e){
        console.error(e);
        setMsg($("msg"), e.message || String(e), true);
      }
    }

    async function loadComments(){
      if(!SELECTED) return;
      const { data, error } = await sb
        .from("comments")
        .select("id, created_at, body, user_id, profiles(username, display_name)")
        .eq("gossip_id", SELECTED.id)
        .order("created_at", { ascending:true });

      if(error) throw error;

      const rows = data || [];
      $("comments").innerHTML = rows.map(c=>{
        const p = c.profiles || {};
        const who = p.display_name ? `${p.display_name} (@${p.username})` : (p.username ? `@${p.username}` : c.user_id);
        return `
          <div class="comment">
            <div class="who">
              <span>${escapeHTML(who)}</span>
              <span class="muted">${new Date(c.created_at).toLocaleString()}</span>
            </div>
            <div class="body">${escapeHTML(c.body)}</div>
          </div>
        `;
      }).join("") || `<div class="muted">Sem comentÃ¡rios ainda. Comece a auditoria social ðŸ˜„</div>`;
    }

    async function addComment(){
      try{
        if(!SESSION || !SELECTED){
          setMsg($("cMsg"), "VocÃª precisa estar logado e com uma fofoca selecionada.", true);
          return;
        }
        const body = $("cBody").value.trim();
        if(body.length < 2){
          setMsg($("cMsg"), "Escreve um comentÃ¡rio de verdade ðŸ˜…", true);
          return;
        }

        const { error } = await sb.from("comments").insert({
          gossip_id: SELECTED.id,
          user_id: SESSION.user.id,
          body
        });
        if(error) throw error;

        $("cBody").value = "";
        setMsg($("cMsg"), "ComentÃ¡rio publicado.");
        await openGossip(SELECTED.id);
        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("cMsg"), e.message || String(e), true);
      }
    }

    async function reactTo(gossipId, reaction){
      try{
        if(!SESSION){
          setMsg($("msg"), "FaÃ§a login para reagir.", true);
          return;
        }
        // toggle: se existe, remove; se nÃ£o, cria
        const { data: existing, error: e1 } = await sb
          .from("reactions")
          .select("id")
          .eq("gossip_id", gossipId)
          .eq("user_id", SESSION.user.id)
          .eq("reaction", reaction)
          .maybeSingle();

        if(e1) throw e1;

        if(existing){
          const { error: e2 } = await sb.from("reactions").delete().eq("id", existing.id);
          if(e2) throw e2;
        }else{
          const { error: e3 } = await sb.from("reactions").insert({
            gossip_id: gossipId,
            user_id: SESSION.user.id,
            reaction
          });
          if(e3) throw e3;
        }

        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("msg"), e.message || String(e), true);
      }
    }

    async function moveStatus(){
      try{
        if(!SESSION || !SELECTED){
          setMsg($("msg"), "Selecione uma fofoca primeiro.", true);
          return;
        }
        // dropdown simples via prompt (sem modal para nÃ£o complicar)
        const opts = ["APURACAO","CONFIRMADO","ARQUIVADO"];
        const next = prompt("Mover para qual status?\n" + opts.join(" | "), SELECTED.status);
        if(!next) return;

        const n = next.trim().toUpperCase();
        if(!opts.includes(n)){
          setMsg($("msg"), "Status invÃ¡lido. Use: " + opts.join(", "), true);
          return;
        }

        // SÃ³ dono pode editar (por policy). Se vocÃª quiser que qualquer um possa mover,
        // a policy no Supabase precisa permitir update geral.
        const { error } = await sb.from("gossips").update({ status: n }).eq("id", SELECTED.id);
        if(error) throw error;

        await openGossip(SELECTED.id);
        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("msg"), e.message || String(e), true);
      }
    }

    async function deleteGossip(){
      try{
        if(!SESSION || !SELECTED){
          setMsg($("msg"), "Selecione uma fofoca primeiro.", true);
          return;
        }
        if(!confirm("Excluir esse ticket de fofoca? Isso vai contra a governanÃ§a de memÃ³ria coletiva.")) return;

        const { error } = await sb.from("gossips").delete().eq("id", SELECTED.id);
        if(error) throw error;

        SELECTED = null;
        $("detail").style.display = "none";
        $("detailEmpty").style.display = "block";
        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("msg"), e.message || String(e), true);
      }
    }

    async function register(){
      try{
        setMsg($("authMsg"), "");
        const username = cleanUser($("u").value);
        const displayName = ($("name").value || username).trim();
        const password = $("p").value;

        if(username.length < 3) { setMsg($("authMsg"), "UsuÃ¡rio muito curto.", true); return; }
        if(password.length < 6) { setMsg($("authMsg"), "Senha precisa ter no mÃ­nimo 6.", true); return; }

        const email = usernameToEmail(username);

        const { data, error } = await sb.auth.signUp({ email, password });
        if(error) throw error;

        // pega sessÃ£o apÃ³s signup
        const { data: sdata } = await sb.auth.getSession();
        SESSION = sdata.session;

        // cria profile (se nÃ£o existir)
        await ensureProfile(username, displayName);

        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("authMsg"), e.message || String(e), true);
      }
    }

    async function login(){
      try{
        setMsg($("authMsg"), "");
        const username = cleanUser($("u").value);
        const password = $("p").value;

        if(username.length < 3) { setMsg($("authMsg"), "UsuÃ¡rio invÃ¡lido.", true); return; }
        if(password.length < 1) { setMsg($("authMsg"), "Digite a senha.", true); return; }

        const email = usernameToEmail(username);

        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) throw error;

        await refreshAll();
      }catch(e){
        console.error(e);
        setMsg($("authMsg"), e.message || String(e), true);
      }
    }

    async function logout(){
      await sb.auth.signOut();
      SESSION = null; ME = null; SELECTED = null;
      $("detail").style.display = "none";
      $("detailEmpty").style.display = "block";
      await refreshAll();
    }

    function setMode(m){
      MODE = m;
      $("tabFeed").classList.toggle("active", m==="feed");
      $("tabMine").classList.toggle("active", m==="mine");
      $("tabProfile").classList.toggle("active", m==="profile");

      $("feedHint").textContent =
        m==="feed" ? "Feed do grupo (todas as fofocas)" :
        m==="mine" ? "Seu Backlog (somente suas fofocas)" :
        "Perfil (em breve: cards + medalhas + histÃ³rico)";

      refreshAll();
    }

    // wire UI
    $("createBtn").addEventListener("click", createTicket);
    $("refreshBtn").addEventListener("click", refreshAll);
    $("commentBtn").addEventListener("click", addComment);
    $("moveBtn").addEventListener("click", moveStatus);
    $("delBtn").addEventListener("click", deleteGossip);
    $("loginBtn").addEventListener("click", login);
    $("registerBtn").addEventListener("click", register);
    $("logoutBtn").addEventListener("click", logout);

    $("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") refreshAll(); });

    $("tabFeed").addEventListener("click", ()=>setMode("feed"));
    $("tabMine").addEventListener("click", ()=>setMode("mine"));
    $("tabProfile").addEventListener("click", ()=>setMode("profile"));

    // global funcs for onclick in HTML strings
    window.openGossip = openGossip;
    window.reactTo = reactTo;

    // realtime-ish: refaz quando auth muda
    sb.auth.onAuthStateChange(async ()=>{
      await refreshAll();
    });

    // start
    refreshAll();
  </script>
</body>
</html>
