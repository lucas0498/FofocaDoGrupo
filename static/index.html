<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FofocaDoGrupo ‚Äî GossipCRM</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c131b;
      --border:#1f2a37;
      --text:#e6edf3;
      --muted:#9aa4b2;
      --blue:#1d4ed8;
      --green:#166534;
      --btn:#143a63;
      --btn2:#153a2a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    header{
      padding:16px 22px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    }
    .brand{ font-weight:900; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; margin-top:3px; }
    .right{ display:flex; align-items:center; gap:10px; }
    .pill{
      padding:8px 12px; border:1px solid var(--border); border-radius:999px;
      background:rgba(255,255,255,.02); color:var(--muted); font-size:12px;
    }
    button{
      cursor:pointer;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:var(--btn);
      color:#fff;
      padding:10px 14px;
      font-weight:700;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    button.secondary{ background:#0f2237; }
    button.green{ background:var(--btn2); border-color:#1f5b40; }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    main{
      max-width:1400px;
      margin:18px auto;
      padding:0 18px 40px;
    }
    .grid{
      display:grid;
      grid-template-columns: 420px minmax(420px, 1fr) 420px;
      gap:18px;
      align-items:start;
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(8px);
    }
    h2{ margin:0 0 10px; }
    .muted{ color:var(--muted); font-size:12px; }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .sp{ height:10px; }
    .topline{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding:8px 12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      color:#dbe5f0;
    }
    .tab.active{ background:rgba(34,197,94,.16); border-color:rgba(34,197,94,.28); }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.20);
    }
    .kpi .n{ font-weight:900; font-size:20px; }
    .kpi .l{ color:var(--muted); font-size:11px; margin-top:2px; }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height: 62vh;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(0,0,0,.20);
      padding:12px;
    }
    .item .t{ font-weight:900; }
    .item .meta{ color:var(--muted); font-size:12px; margin-top:4px; display:flex; gap:8px; flex-wrap:wrap; }
    .badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
    }
    .btnrow{ display:flex; gap:8px; margin-top:10px; }
    .danger{ background:#5b1622; }

    .hidden{ display:none !important; }

    /* Mobile */
    @media (max-width: 1120px){
      .grid{ grid-template-columns: 1fr; }
      .list{ max-height: 40vh; }
    }
  </style>
</head>

<body>
<header>
  <div>
    <div class="brand">FofocaDoGrupo</div>
    <div class="sub">Fofoca Management ‚Ä¢ Observability ‚Ä¢ Compliance ‚Ä¢ Governan√ßa de Tias</div>
  </div>

  <div class="right">
    <span id="who" class="pill">N√£o logado</span>
    <button id="logoutBtn" class="secondary hidden">Sair</button>
  </div>
</header>

<main>
  <!-- AUTH -->
  <section class="card" id="authCard">
    <h2>Acesso</h2>
    <div class="muted">Crie sua conta e vire uma entidade do bairro. (Login sem email real)</div>

    <div class="sp"></div>

    <div id="authModeHint" class="muted">Modo: <b>Login</b></div>
    <div class="sp"></div>

    <input id="username" placeholder="Usu√°rio (ex: lucas_fofoca)" autocomplete="username"/>
    <div class="sp"></div>

    <input id="displayName" placeholder="Nome (ex: Lucas)" class="hidden" autocomplete="name"/>
    <div class="sp hidden" id="spName"></div>

    <input id="password" placeholder="Senha (m√≠n. 6)" type="password" autocomplete="current-password"/>
    <div class="sp"></div>

    <button id="loginBtn">Entrar</button>
    <div class="btnrow">
      <button id="toRegisterBtn" class="green" style="flex:1;">Criar conta</button>
      <button id="toLoginBtn" class="secondary hidden" style="flex:1;">Voltar para o login</button>
    </div>

    <div id="authMsg" class="muted" style="margin-top:10px;"></div>
    <div class="sp"></div>
    <div class="muted">Dica: seu ‚Äúemail interno‚Äù vira <b>usuario@fofoca.local</b> automaticamente.</div>
  </section>

  <!-- APP -->
  <section class="grid hidden" id="appGrid">
    <!-- LEFT: DASH + CREATE -->
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;">Dashboard</h2>
          <div class="muted" id="titleLine">T√≠tulo: ‚Äî</div>
        </div>
        <button id="refreshBtn">Atualizar</button>
      </div>

      <div class="sp"></div>

      <div class="tabs">
        <div class="tab active" id="tabFeed">Feed (grupo)</div>
        <div class="tab" id="tabMine">Meu Backlog</div>
        <div class="tab" id="tabProfile">Perfil</div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="n" id="kTotal">‚Äî</div><div class="l">Tickets totais</div></div>
        <div class="kpi"><div class="n" id="kConf">‚Äî</div><div class="l">CONFIRMADO</div></div>
        <div class="kpi"><div class="n" id="kApur">‚Äî</div><div class="l">APURA√á√ÉO</div></div>
        <div class="kpi"><div class="n" id="kArq">‚Äî</div><div class="l">ARQUIVADO</div></div>
      </div>

      <div class="sp"></div>
      <hr style="border:0;border-top:1px solid rgba(255,255,255,.08);"/>

      <h3 style="margin:12px 0 8px;">Nova ocorr√™ncia</h3>

      <label class="muted">T√≠tulo</label>
      <input id="newTitle" placeholder="Ex: Fulano foi visto com..." />
      <div class="sp"></div>

      <div class="row">
        <div>
          <label class="muted">Fonte</label>
          <input id="newSource" placeholder="Ex: zelador, grupo da fam√≠lia" />
        </div>
        <div>
          <label class="muted">Status</label>
          <select id="newStatus">
            <option value="APURACAO">APURA√á√ÉO</option>
            <option value="CONFIRMADO">CONFIRMADO</option>
            <option value="ARQUIVADO">ARQUIVADO</option>
          </select>
        </div>
      </div>

      <div class="sp"></div>

      <label class="muted">Detalhes</label>
      <textarea id="newDetails" placeholder="Descreva com seriedade corporativa... (use @usuario para mencionar)"></textarea>

      <div class="sp"></div>
      <div class="row">
        <div>
          <label class="muted">Confiabilidade (0‚Äì100)</label>
          <input id="newCred" type="number" min="0" max="100" value="50"/>
        </div>
        <div>
          <label class="muted">Tags (v√≠rgula)</label>
          <input id="newTags" placeholder="fonte confi√°vel, ouvi falar" />
        </div>
      </div>

      <div class="sp"></div>
      <button id="createBtn" class="green" style="width:100%;">Registrar ticket</button>
      <div id="createMsg" class="muted" style="margin-top:10px;"></div>
    </section>

    <!-- CENTER: FEED/BACKLOG -->
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;">Explorar</h2>
          <div class="muted" id="exploreHint">Feed do grupo (todas as fofocas)</div>
        </div>
        <input id="search" placeholder="Pesquisar..." style="max-width:320px;"/>
      </div>

      <div class="sp"></div>
      <div class="list" id="list"></div>
      <div id="listMsg" class="muted" style="margin-top:10px;"></div>
    </section>

    <!-- RIGHT: DETAILS -->
    <section class="card">
      <div class="topline">
        <h2 style="margin:0;">Visualiza√ß√£o</h2>
        <div class="muted">Detalhes + colabora√ß√£o</div>
      </div>
      <div class="sp"></div>

      <div id="detailsEmpty" class="muted">Selecione uma fofoca no feed/backlog para ver detalhes e colaborar.</div>

      <div id="detailsBox" class="hidden">
        <div class="item">
          <div class="t" id="dTitle">‚Äî</div>
          <div class="meta" id="dMeta"></div>
          <div class="sp"></div>
          <div id="dDetails" style="white-space:pre-wrap;"></div>
          <div class="sp"></div>
          <div class="meta" id="dTags"></div>

          <div class="sp"></div>
          <div class="row">
            <div>
              <label class="muted">Mover status</label>
              <select id="moveStatus">
                <option value="APURACAO">APURA√á√ÉO</option>
                <option value="CONFIRMADO">CONFIRMADO</option>
                <option value="ARQUIVADO">ARQUIVADO</option>
              </select>
            </div>
            <div style="display:flex; align-items:end;">
              <button id="moveBtn" style="width:100%;">Mover</button>
            </div>
          </div>

          <div class="sp"></div>
          <div class="btnrow">
            <button id="delBtn" class="danger" style="flex:1;">Excluir (meu)</button>
          </div>

          <div id="dMsg" class="muted" style="margin-top:10px;"></div>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- Supabase v2 UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ======= CONFIG (cole seus valores aqui) =======
  const SUPABASE_URL = "https://vguiwuiwgiuhtoifgjin.supabase.co";
  const SUPABASE_ANON_KEY = "COLE_SUA_ANON_KEY_AQUI";
  // ==============================================

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // UI refs
  const authCard = document.getElementById('authCard');
  const appGrid  = document.getElementById('appGrid');
  const who      = document.getElementById('who');
  const logoutBtn= document.getElementById('logoutBtn');

  const usernameEl   = document.getElementById('username');
  const displayNameEl= document.getElementById('displayName');
  const spName       = document.getElementById('spName');
  const passwordEl   = document.getElementById('password');
  const authMsg      = document.getElementById('authMsg');
  const authModeHint = document.getElementById('authModeHint');

  const loginBtn     = document.getElementById('loginBtn');
  const toRegisterBtn= document.getElementById('toRegisterBtn');
  const toLoginBtn   = document.getElementById('toLoginBtn');

  const refreshBtn   = document.getElementById('refreshBtn');
  const createBtn    = document.getElementById('createBtn');
  const createMsg    = document.getElementById('createMsg');

  const tabFeed      = document.getElementById('tabFeed');
  const tabMine      = document.getElementById('tabMine');
  const tabProfile   = document.getElementById('tabProfile');
  const exploreHint  = document.getElementById('exploreHint');

  const listEl       = document.getElementById('list');
  const listMsg      = document.getElementById('listMsg');
  const searchEl     = document.getElementById('search');

  const kTotal = document.getElementById('kTotal');
  const kConf  = document.getElementById('kConf');
  const kApur  = document.getElementById('kApur');
  const kArq   = document.getElementById('kArq');

  const titleLine = document.getElementById('titleLine');

  const newTitle  = document.getElementById('newTitle');
  const newSource = document.getElementById('newSource');
  const newStatus = document.getElementById('newStatus');
  const newDetails= document.getElementById('newDetails');
  const newCred   = document.getElementById('newCred');
  const newTags   = document.getElementById('newTags');

  const detailsEmpty = document.getElementById('detailsEmpty');
  const detailsBox   = document.getElementById('detailsBox');
  const dTitle       = document.getElementById('dTitle');
  const dMeta        = document.getElementById('dMeta');
  const dDetails     = document.getElementById('dDetails');
  const dTags        = document.getElementById('dTags');
  const moveStatus   = document.getElementById('moveStatus');
  const moveBtn      = document.getElementById('moveBtn');
  const delBtn       = document.getElementById('delBtn');
  const dMsg         = document.getElementById('dMsg');

  let mode = 'feed'; // feed | mine | profile
  let selected = null;

  function showAuth(){
    authCard.classList.remove('hidden');
    appGrid.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    who.textContent = 'N√£o logado';
  }
  function showApp(label){
    authCard.classList.add('hidden');
    appGrid.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    who.textContent = label || 'Logado';
  }

  function normUsername(u){
    return (u||'').trim().toLowerCase().replace(/[^a-z0-9_]/g,'_');
  }

  function makeEmail(username){
    return `${username}@fofoca.local`;
  }

  function setAuthMode(isRegister){
    if(isRegister){
      authModeHint.innerHTML = 'Modo: <b>Criar conta</b>';
      displayNameEl.classList.remove('hidden');
      spName.classList.remove('hidden');
      toLoginBtn.classList.remove('hidden');
      toRegisterBtn.classList.add('hidden');
      loginBtn.textContent = 'Criar e entrar';
    }else{
      authModeHint.innerHTML = 'Modo: <b>Login</b>';
      displayNameEl.classList.add('hidden');
      spName.classList.add('hidden');
      toLoginBtn.classList.add('hidden');
      toRegisterBtn.classList.remove('hidden');
      loginBtn.textContent = 'Entrar';
    }
    authMsg.textContent = '';
  }

  toRegisterBtn.onclick = () => setAuthMode(true);
  toLoginBtn.onclick = () => setAuthMode(false);

  async function ensureProfile(user, username, displayName){
    // tenta buscar
    const { data: prof, error: e1 } = await sb
      .from('profiles')
      .select('id, username, display_name')
      .eq('id', user.id)
      .maybeSingle();

    if(e1 && e1.code !== 'PGRST116'){ /* ignore not found */ }

    if(prof) return prof;

    const payload = {
      id: user.id,
      username,
      display_name: displayName || username
    };

    const { data, error } = await sb.from('profiles').insert(payload).select().single();
    if(error) throw error;
    return data;
  }

  async function doLoginOrRegister(){
    authMsg.textContent = '';

    const rawU = usernameEl.value;
    const username = normUsername(rawU);
    const password = passwordEl.value || '';
    const displayName = displayNameEl.value.trim();

    if(!username || username.length < 3){
      authMsg.textContent = 'Usu√°rio inv√°lido (m√≠n. 3). Use letras/n√∫meros/_';
      return;
    }
    if(password.length < 6){
      authMsg.textContent = 'Senha muito curta (m√≠n. 6).';
      return;
    }

    const email = makeEmail(username);

    try{
      if(loginBtn.textContent.includes('Criar')){
        // SIGN UP
        const { data: su, error: eSU } = await sb.auth.signUp({
          email,
          password,
          options: { data: { username, display_name: displayName || username } }
        });
        if(eSU) throw eSU;

        // Se email confirmation estiver OFF, j√° vem session.
        // Se vier sem session, tenta login em seguida.
        if(!su.session){
          const { data: si2, error: eSI2 } = await sb.auth.signInWithPassword({ email, password });
          if(eSI2) throw eSI2;
        }

      }else{
        // SIGN IN
        const { error: eSI } = await sb.auth.signInWithPassword({ email, password });
        if(eSI) throw eSI;
      }

      // sess√£o atual
      const { data: ses } = await sb.auth.getSession();
      const user = ses?.session?.user;
      if(!user) throw new Error('N√£o consegui obter sess√£o. Verifique o Email Confirm OFF.');

      const prof = await ensureProfile(user, username, displayName || username);
      showApp(`Logado como: ${prof.display_name} (@${prof.username})`);
      setAuthMode(false);
      await refresh();

    }catch(err){
      authMsg.textContent = (err?.message || 'Erro de autentica√ß√£o');
    }
  }

  loginBtn.onclick = doLoginOrRegister;

  logoutBtn.onclick = async () => {
    await sb.auth.signOut();
    showAuth();
  };

  function setActiveTab(el){
    [tabFeed, tabMine, tabProfile].forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
  }

  tabFeed.onclick = async () => { mode='feed'; setActiveTab(tabFeed); exploreHint.textContent='Feed do grupo (todas as fofocas)'; await refresh(); };
  tabMine.onclick = async () => { mode='mine'; setActiveTab(tabMine); exploreHint.textContent='Meu Backlog (s√≥ minhas fofocas)'; await refresh(); };
  tabProfile.onclick = async () => { mode='profile'; setActiveTab(tabProfile); exploreHint.textContent='Perfil (em breve: medalhas + t√≠tulos)'; await refresh(); };

  refreshBtn.onclick = refresh;

  createBtn.onclick = async () => {
    createMsg.textContent = '';
    try{
      const { data: ses } = await sb.auth.getSession();
      const user = ses?.session?.user;
      if(!user){
        createMsg.textContent = 'Voc√™ precisa estar logado para registrar.';
        return;
      }

      const title = newTitle.value.trim();
      const source = newSource.value.trim();
      const details = newDetails.value.trim();
      const status = newStatus.value;
      const credibility = Math.max(0, Math.min(100, parseInt(newCred.value || '50', 10)));
      const tags = (newTags.value || '')
        .split(',')
        .map(s=>s.trim())
        .filter(Boolean);

      if(!title || !source || !details){
        createMsg.textContent = 'Preencha T√≠tulo, Fonte e Detalhes.';
        return;
      }

      const payload = {
        title, source, details, status,
        credibility,
        tags,
        created_by: user.id
      };

      const { error } = await sb.from('gossips').insert(payload);
      if(error) throw error;

      newTitle.value=''; newSource.value=''; newDetails.value=''; newTags.value=''; newCred.value='50'; newStatus.value='APURACAO';
      createMsg.textContent = 'Ticket registrado com excel√™ncia operacional. ‚úÖ';
      await refresh();

    }catch(err){
      createMsg.textContent = (err?.message || 'Erro ao registrar');
    }
  };

  searchEl.oninput = () => renderList(window.__lastRows || []);

  function setSelected(row){
    selected = row;
    detailsEmpty.classList.add('hidden');
    detailsBox.classList.remove('hidden');
    dMsg.textContent='';

    dTitle.textContent = row.title;
    dDetails.textContent = row.details;

    const meta = [];
    meta.push(`<span class="badge">${row.status}</span>`);
    meta.push(`<span class="badge">Cred ${row.credibility}</span>`);
    meta.push(`<span class="badge">Por: ${row.author_display_name || ‚Äò‚Äî‚Äô} (@${row.author_username || ‚Äò‚Äî‚Äô})</span>`);
    meta.push(`<span class="badge">${new Date(row.created_at).toLocaleString()}</span>`);
    dMeta.innerHTML = meta.join(' ');

    dTags.innerHTML = (row.tags || []).map(t=>`<span class="badge">${t}</span>`).join(' ');
    moveStatus.value = row.status;

    // habilita excluir/mover apenas se for dono (server RLS tamb√©m confere)
    delBtn.disabled = !row.is_mine;
    moveBtn.disabled = !row.is_mine;
  }

  moveBtn.onclick = async () => {
    if(!selected) return;
    dMsg.textContent='';
    try{
      const to = moveStatus.value;
      const { error } = await sb.from('gossips').update({ status: to }).eq('id', selected.id);
      if(error) throw error;
      dMsg.textContent='Status atualizado.';
      await refresh(true);
    }catch(err){
      dMsg.textContent = err?.message || 'Erro ao mover';
    }
  };

  delBtn.onclick = async () => {
    if(!selected) return;
    dMsg.textContent='';
    try{
      const { error } = await sb.from('gossips').delete().eq('id', selected.id);
      if(error) throw error;
      dMsg.textContent='Exclu√≠do.';
      selected = null;
      detailsBox.classList.add('hidden');
      detailsEmpty.classList.remove('hidden');
      await refresh();
    }catch(err){
      dMsg.textContent = err?.message || 'Erro ao excluir';
    }
  };

  function renderList(rows){
    const q = (searchEl.value || '').toLowerCase().trim();
    const filtered = !q ? rows : rows.filter(r =>
      (r.title||'').toLowerCase().includes(q) ||
      (r.details||'').toLowerCase().includes(q) ||
      (r.source||'').toLowerCase().includes(q) ||
      (r.author_username||'').toLowerCase().includes(q)
    );

    listEl.innerHTML = '';
    if(filtered.length === 0){
      listMsg.textContent = 'Nada por aqui ainda.';
      return;
    }
    listMsg.textContent = '';

    for(const r of filtered){
      const div = document.createElement('div');
      div.className='item';

      const preview = (r.details || '').split('\n').slice(0,2).join('\n');
      const tags = (r.tags || []).slice(0,3).map(t=>`<span class="badge">${t}</span>`).join(' ');

      div.innerHTML = `
        <div class="t">${escapeHtml(r.title)}</div>
        <div class="meta">
          <span class="badge">${r.status}</span>
          <span class="badge">Cred ${r.credibility}</span>
          <span class="badge">Por: ${escapeHtml(r.author_display_name || '‚Äî')} (@${escapeHtml(r.author_username || '‚Äî')})</span>
          <span class="badge">üí¨ ${r.comment_count || 0}</span>
        </div>
        <div class="sp"></div>
        <div style="white-space:pre-wrap; color:#cdd6e1; font-size:13px;">${escapeHtml(preview)}${(r.details||'').includes('\n') ? '‚Ä¶' : ''}</div>
        <div class="sp"></div>
        <div class="meta">${tags}</div>
        <div class="sp"></div>
        <div class="btnrow">
          <button class="secondary" data-open="1">Abrir</button>
        </div>
      `;

      div.querySelector('[data-open="1"]').onclick = () => setSelected(r);
      listEl.appendChild(div);
    }
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  async function refresh(keepSelected=false){
    listMsg.textContent = '';
    createMsg.textContent = '';

    const { data: ses } = await sb.auth.getSession();
    const user = ses?.session?.user;
    if(!user){
      showAuth();
      return;
    }

    // carrega profile
    const { data: prof } = await sb.from('profiles').select('username, display_name').eq('id', user.id).maybeSingle();
    showApp(`Logado como: ${prof?.display_name || '‚Äî'} (@${prof?.username || '‚Äî'})`);
    titleLine.textContent = `T√≠tulo: Aprendiz de Fofoqueiro(a) ü™¥ ‚Ä¢ Fofoqueiro(a): ${prof?.display_name || '‚Äî'} (@${prof?.username || '‚Äî'})`;

    // query feed/backlog
    let q = sb.from('gossip_cards').select('*').order('created_at', { ascending:false }).limit(50);

    if(mode === 'mine'){
      q = q.eq('created_by', user.id);
    }

    const { data: rows, error } = await q;
    if(error){
      listMsg.textContent = error.message || 'Erro ao carregar feed';
      return;
    }

    // marca se √© do usu√°rio
    const rows2 = (rows || []).map(r => ({...r, is_mine: (r.created_by === user.id)}));
    window.__lastRows = rows2;

    // KPIs (simples)
    const total = rows2.length;
    const conf  = rows2.filter(r=>r.status==='CONFIRMADO').length;
    const apur  = rows2.filter(r=>r.status==='APURACAO').length;
    const arq   = rows2.filter(r=>r.status==='ARQUIVADO').length;
    kTotal.textContent = total;
    kConf.textContent = conf;
    kApur.textContent = apur;
    kArq.textContent = arq;

    renderList(rows2);

    if(keepSelected && selected){
      const again = rows2.find(r=>r.id === selected.id);
      if(again) setSelected(again);
    }
  }

  // Startup: decide se mostra login ou app
  (async () => {
    setAuthMode(false);

    const { data: ses } = await sb.auth.getSession();
    if(ses?.session?.user){
      await refresh();
    }else{
      showAuth();
    }

    sb.auth.onAuthStateChange(async (event, session) => {
      if(session?.user) await refresh();
      else showAuth();
    });
  })();
</script>
</body>
</html>
